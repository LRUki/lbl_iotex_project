"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.WsSignerPlugin = void 0;

var _window = _interopRequireDefault(require("global/window"));

var _isomorphicWs = _interopRequireDefault(require("isomorphic-ws"));

var _account = require("../account/account");

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

function _defineProperty(obj, key, value) { if (key in obj) { Object.defineProperty(obj, key, { value: value, enumerable: true, configurable: true, writable: true }); } else { obj[key] = value; } return obj; }

// tslint:disable-next-line:insecure-random
let reqId = Math.round(Math.random() * 10000);

class WsSignerPlugin {
  constructor(provider = "wss://local.get-scatter.com:64102", options = {
    retryCount: 3,
    retryDuration: 50
  }) {
    _defineProperty(this, "ws", void 0);

    _defineProperty(this, "provider", void 0);

    _defineProperty(this, "options", void 0);

    this.provider = provider;
    this.options = options;
    this.init();
  }

  init() {
    this.ws = new _isomorphicWs.default(this.provider);

    this.ws.onopen = () => {
      _window.default.console.log("[antenna-ws] connected");
    };

    this.ws.onclose = () => {
      _window.default.console.log("[antenna-ws] disconnected");
    };
  }

  send(req) {
    const readyState = this.ws.readyState;

    if (readyState === 1) {
      this.ws.send(JSON.stringify(req));
    } else {
      if (readyState === 2 || readyState === 3) {
        this.init();
      }

      this.reconnectAndSend(this.options.retryCount, req);
    }
  }

  reconnectAndSend(retryCount, req, timeoutId) {
    const readyState = this.ws.readyState;

    if (timeoutId) {
      _window.default.clearTimeout(timeoutId);
    }

    if (retryCount > 0) {
      const id = _window.default.setTimeout(() => {
        if (readyState === 1) {
          this.ws.send(JSON.stringify(req));

          _window.default.clearTimeout(id);
        } else {
          const count = retryCount - 1;
          this.reconnectAndSend(count, req, id);
        }
      }, this.options.retryDuration);
    } else {
      _window.default.console.error("ws plugin connect error, please retry again later.");
    }
  }

  async signAndSend(envelop) {
    const id = reqId++;
    const req = {
      reqId: id,
      envelop: Buffer.from(envelop.bytestream()).toString("hex"),
      type: "SIGN_AND_SEND",
      origin: this.getOrigin()
    };
    this.send(req); // tslint:disable-next-line:promise-must-complete

    return new Promise(resolve => {
      this.ws.onmessage = event => {
        let resp = {
          reqId: -1,
          actionHash: ""
        };

        try {
          if (typeof event.data === "string") {
            resp = JSON.parse(event.data);
          }
        } catch (_) {
          return;
        }

        if (resp.reqId === id) {
          resolve(resp.actionHash);
        }
      };
    });
  }

  async getAccount(address) {
    const acct = new _account.Account();
    acct.address = address;
    return acct;
  }

  async getAccounts() {
    const id = reqId++;
    const req = {
      reqId: id,
      type: "GET_ACCOUNTS"
    };
    this.send(req); // tslint:disable-next-line:promise-must-complete

    return new Promise(resolve => {
      this.ws.onmessage = event => {
        let resp = {
          reqId: -1,
          accounts: []
        };

        try {
          if (typeof event.data === "string") {
            resp = JSON.parse(event.data);
          }
        } catch (_) {
          return;
        }

        if (resp.reqId === id) {
          resolve(resp.accounts);
        }
      };
    });
  }

  getOrigin(plugin = "") {
    let origin = "";

    if (location !== undefined && location.hasOwnProperty("hostname") && location.hostname.length) {
      origin = location.hostname;
    } else {
      origin = plugin;
    }

    if (origin.substr(0, 4) === "www.") {
      origin = origin.replace("www.", "");
    }

    return origin;
  }

}

exports.WsSignerPlugin = WsSignerPlugin;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9wbHVnaW4vd3MudHMiXSwibmFtZXMiOlsicmVxSWQiLCJNYXRoIiwicm91bmQiLCJyYW5kb20iLCJXc1NpZ25lclBsdWdpbiIsImNvbnN0cnVjdG9yIiwicHJvdmlkZXIiLCJvcHRpb25zIiwicmV0cnlDb3VudCIsInJldHJ5RHVyYXRpb24iLCJpbml0Iiwid3MiLCJXZWJTb2NrZXQiLCJvbm9wZW4iLCJ3aW5kb3ciLCJjb25zb2xlIiwibG9nIiwib25jbG9zZSIsInNlbmQiLCJyZXEiLCJyZWFkeVN0YXRlIiwiSlNPTiIsInN0cmluZ2lmeSIsInJlY29ubmVjdEFuZFNlbmQiLCJ0aW1lb3V0SWQiLCJjbGVhclRpbWVvdXQiLCJpZCIsInNldFRpbWVvdXQiLCJjb3VudCIsImVycm9yIiwic2lnbkFuZFNlbmQiLCJlbnZlbG9wIiwiQnVmZmVyIiwiZnJvbSIsImJ5dGVzdHJlYW0iLCJ0b1N0cmluZyIsInR5cGUiLCJvcmlnaW4iLCJnZXRPcmlnaW4iLCJQcm9taXNlIiwicmVzb2x2ZSIsIm9ubWVzc2FnZSIsImV2ZW50IiwicmVzcCIsImFjdGlvbkhhc2giLCJkYXRhIiwicGFyc2UiLCJfIiwiZ2V0QWNjb3VudCIsImFkZHJlc3MiLCJhY2N0IiwiQWNjb3VudCIsImdldEFjY291bnRzIiwiYWNjb3VudHMiLCJwbHVnaW4iLCJsb2NhdGlvbiIsInVuZGVmaW5lZCIsImhhc093blByb3BlcnR5IiwiaG9zdG5hbWUiLCJsZW5ndGgiLCJzdWJzdHIiLCJyZXBsYWNlIl0sIm1hcHBpbmdzIjoiOzs7Ozs7O0FBQ0E7O0FBQ0E7O0FBQ0E7Ozs7OztBQUlBO0FBQ0EsSUFBSUEsS0FBSyxHQUFHQyxJQUFJLENBQUNDLEtBQUwsQ0FBV0QsSUFBSSxDQUFDRSxNQUFMLEtBQWdCLEtBQTNCLENBQVo7O0FBbUJPLE1BQU1DLGNBQU4sQ0FBNkM7QUFPbERDLEVBQUFBLFdBQVcsQ0FDVEMsUUFBZ0IsR0FBRyxtQ0FEVixFQUVUQyxPQUE4QixHQUFHO0FBQUVD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WCxLQUFLLENBQUNHLElBQWIsS0FBc0IsUUFBMUIsRUFBb0M7QUFDbENGLFlBQUFBLElBQUksR0FBR3RCLElBQUksQ0FBQ3lCLEtBQUwsQ0FBV0osS0FBSyxDQUFDRyxJQUFqQixDQUFQO0FBQ0Q7QUFDRixTQUpELENBSUUsT0FBT0UsQ0FBUCxFQUFVO0FBQ1Y7QUFDRDs7QUFDRCxZQUFJSixJQUFJLENBQUMzQyxLQUFMLEtBQWUwQixFQUFuQixFQUF1QjtBQUNyQmMsVUFBQUEsT0FBTyxDQUFDRyxJQUFJLENBQUNVLFFBQU4sQ0FBUDtBQUNEO0FBQ0YsT0FaRDtBQWFELEtBZE0sQ0FBUDtBQWVEOztBQUVNZixFQUFBQSxTQUFQLENBQWlCZ0IsTUFBYyxHQUFHLEVBQWxDLEVBQThDO0FBQzVDLFFBQUlqQixNQUFjLEdBQUcsRUFBckI7O0FBQ0EsUUFDRWtCLFFBQVEsS0FBS0MsU0FBYixJQUNBRCxRQUFRLENBQUNFLGNBQVQsQ0FBd0IsVUFBeEIsQ0FEQSxJQUVBRixRQUFRLENBQUNHLFFBQVQsQ0FBa0JDLE1BSHBCLEVBSUU7QUFDQXRCLE1BQUFBLE1BQU0sR0FBR2tCLFFBQVEsQ0FBQ0csUUFBbEI7QUFDRCxLQU5ELE1BTU87QUFDTHJCLE1BQUFBLE1BQU0sR0FBR2lCLE1BQVQ7QUFDRDs7QUFFRCxRQUFJakIsTUFBTSxDQUFDdUIsTUFBUCxDQUFjLENBQWQsRUFBaUIsQ0FBakIsTUFBd0IsTUFBNUIsRUFBb0M7QUFDbEN2QixNQUFBQSxNQUFNLEdBQUdBLE1BQU0sQ0FBQ3dCLE9BQVAsQ0FBZSxNQUFmLEVBQXVCLEVBQXZCLENBQVQ7QUFDRDs7QUFDRCxXQUFPeEIsTUFBUDtBQUNEOztBQS9JaUQiLCJzb3VyY2VzQ29udGVudCI6WyIvLyBAdHMtaWdub3JlXG5pbXBvcnQgd2luZG93IGZyb20gXCJnbG9iYWwvd2luZG93XCI7XG5pbXBvcnQgV2ViU29ja2V0IGZyb20gXCJpc29tb3JwaGljLXdzXCI7XG5pbXBvcnQgeyBBY2NvdW50IH0gZnJvbSBcIi4uL2FjY291bnQvYWNjb3VudFwiO1xuaW1wb3J0IHsgRW52ZWxvcCB9IGZyb20gXCIuLi9hY3Rpb24vZW52ZWxvcFwiO1xuaW1wb3J0IHsgU2lnbmVyUGx1Z2luIH0gZnJvbSBcIi4uL2FjdGlvbi9tZXRob2RcIjtcblxuLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOmluc2VjdXJlLXJhbmRvbVxubGV0IHJlcUlkID0gTWF0aC5yb3VuZChNYXRoLnJhbmRvbSgpICogMTAwMDApO1xuXG5pbnRlcmZhY2UgSVJlcXVlc3Qge1xuICByZXFJZDogbnVtYmVyO1xuICB0eXBlOiBcIlNJR05fQU5EX1NFTkRcIiB8IFwiR0VUX0FDQ09VTlRTXCI7XG4gIGVudmVsb3A/OiBzdHJpbmc7IC8vIHNlcmlhbGl6ZWQgcHJvdG8gc3RyaW5nXG4gIG9yaWdpbj86IHN0cmluZztcbn1cblxuZXhwb3J0IGludGVyZmFjZSBXc1NpZ25lclBsdWdpbk9wdGlvbnMge1xuICByZXRyeUNvdW50OiBudW1iZXI7XG4gIHJldHJ5RHVyYXRpb246IG51bWJlcjtcbn1cblxuZXhwb3J0IGludGVyZmFjZSBXc1JlcXVlc3Qge1xuICAvLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmU6IG5vLWFueVxuICBba2V5OiBzdHJpbmddOiBhbnk7XG59XG5cbmV4cG9ydCBjbGFzcyBXc1NpZ25lclBsdWdpbiBpbXBsZW1lbnRzIFNpZ25lclBsdWdpbiB7XG4gIHByaXZhdGUgd3M6IFdlYlNvY2tldDtcblxuICBwcml2YXRlIHJlYWRvbmx5IHByb3ZpZGVyOiBzdHJpbmc7XG5cbiAgcHJpdmF0ZSByZWFkb25seSBvcHRpb25zOiBXc1NpZ25lclBsdWdpbk9wdGlvbnM7XG5cbiAgY29uc3RydWN0b3IoXG4gICAgcHJvdmlkZXI6IHN0cmluZyA9IFwid3NzOi8vbG9jYWwuZ2V0LXNjYXR0ZXIuY29tOjY0MTAyXCIsXG4gICAgb3B0aW9uczogV3NTaWduZXJQbHVnaW5PcHRpb25zID0geyByZXRyeUNvdW50OiAzLCByZXRyeUR1cmF0aW9uOiA1MCB9XG4gICkge1xuICAgIHRoaXMucHJvdmlkZXIgPSBwcm92aWRlcjtcblxuICAgIHRoaXMub3B0aW9ucyA9IG9wdGlvbnM7XG5cbiAgICB0aGlzLmluaXQoKTtcbiAgfVxuXG4gIHByaXZhdGUgaW5pdCgpOiB2b2lkIHtcbiAgICB0aGlzLndzID0gbmV3IFdlYlNvY2tldCh0aGlzLnByb3ZpZGVyKTtcbiAgICB0aGlzLndzLm9ub3BlbiA9ICgpOiB2b2lkID0+IHtcbiAgICAgIHdpbmRvdy5jb25zb2xlLmxvZyhcIlthbnRlbm5hLXdzXSBjb25uZWN0ZWRcIik7XG4gICAgfTtcbiAgICB0aGlzLndzLm9uY2xvc2UgPSAoKTogdm9pZCA9PiB7XG4gICAgICB3aW5kb3cuY29uc29sZS5sb2coXCJbYW50ZW5uYS13c10gZGlzY29ubmVjdGVkXCIpO1xuICAgIH07XG4gIH1cblxuICBwcml2YXRlIHNlbmQocmVxOiBXc1JlcXVlc3QpOiB2b2lkIHtcbiAgICBjb25zdCByZWFkeVN0YXRlID0gdGhpcy53cy5yZWFkeVN0YXRlO1xuXG4gICAgaWYgKHJlYWR5U3RhdGUgPT09IDEpIHtcbiAgICAgIHRoaXMud3Muc2VuZChKU09OLnN0cmluZ2lmeShyZXEpKTtcbiAgICB9IGVsc2Uge1xuICAgICAgaWYgKHJlYWR5U3RhdGUgPT09IDIgfHwgcmVhZHlTdGF0ZSA9PT0gMykge1xuICAgICAgICB0aGlzLmluaXQoKTtcbiAgICAgIH1cbiAgICAgIHRoaXMucmVjb25uZWN0QW5kU2VuZCh0aGlzLm9wdGlvbnMucmV0cnlDb3VudCwgcmVxKTtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIHJlY29ubmVjdEFuZFNlbmQoXG4gICAgcmV0cnlDb3VudDogbnVtYmVyLFxuICAgIHJlcTogV3NSZXF1ZXN0LFxuICAgIHRpbWVvdXRJZD86IG51bWJlclxuICApOiB2b2lkIHtcbiAgICBjb25zdCByZWFkeVN0YXRlID0gdGhpcy53cy5yZWFkeVN0YXRlO1xuXG4gICAgaWYgKHRpbWVvdXRJZCkge1xuICAgICAgd2luZG93LmNsZWFyVGltZW91dCh0aW1lb3V0SWQpO1xuICAgIH1cblxuICAgIGlmIChyZXRyeUNvdW50ID4gMCkge1xuICAgICAgY29uc3QgaWQgPSB3aW5kb3cuc2V0VGltZW91dCgoKSA9PiB7XG4gICAgICAgIGlmIChyZWFkeVN0YXRlID09PSAxKSB7XG4gICAgICAgICAgdGhpcy53cy5zZW5kKEpTT04uc3RyaW5naWZ5KHJlcSkpO1xuICAgICAgICAgIHdpbmRvdy5jbGVhclRpbWVvdXQoaWQpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIGNvbnN0IGNvdW50ID0gcmV0cnlDb3VudCAtIDE7XG4gICAgICAgICAgdGhpcy5yZWNvbm5lY3RBbmRTZW5kKGNvdW50LCByZXEsIGlkKTtcbiAgICAgICAgfVxuICAgICAgfSwgdGhpcy5vcHRpb25zLnJldHJ5RHVyYXRpb24pO1xuICAgIH0gZWxzZSB7XG4gICAgICB3aW5kb3cuY29uc29sZS5lcnJvcihcbiAgICAgICAgXCJ3cyBwbHVnaW4gY29ubmVjdCBlcnJvciwgcGxlYXNlIHJldHJ5IGFnYWluIGxhdGVyLlwiXG4gICAgICApO1xuICAgIH1cbiAgfVxuXG4gIHB1YmxpYyBhc3luYyBzaWduQW5kU2VuZChlbnZlbG9wOiBFbnZlbG9wKTogUHJvbWlzZTxzdHJpbmc+IHtcbiAgICBjb25zdCBpZCA9IHJlcUlkKys7XG4gICAgY29uc3QgcmVxOiBJUmVxdWVzdCA9IHtcbiAgICAgIHJlcUlkOiBpZCxcbiAgICAgIGVudmVsb3A6IEJ1ZmZlci5mcm9tKGVudmVsb3AuYnl0ZXN0cmVhbSgpKS50b1N0cmluZyhcImhleFwiKSxcbiAgICAgIHR5cGU6IFwiU0lHTl9BTkRfU0VORFwiLFxuICAgICAgb3JpZ2luOiB0aGlzLmdldE9yaWdpbigpXG4gICAgfTtcbiAgICB0aGlzLnNlbmQocmVxKTtcbiAgICAvLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmU6cHJvbWlzZS1tdXN0LWNvbXBsZXRlXG4gICAgcmV0dXJuIG5ldyBQcm9taXNlPHN0cmluZz4ocmVzb2x2ZSA9PiB7XG4gICAgICB0aGlzLndzLm9ubWVzc2FnZSA9IGV2ZW50ID0+IHtcbiAgICAgICAgbGV0IHJlc3AgPSB7IHJlcUlkOiAtMSwgYWN0aW9uSGFzaDogXCJcIiB9O1xuICAgICAgICB0cnkge1xuICAgICAgICAgIGlmICh0eXBlb2YgZXZlbnQuZGF0YSA9PT0gXCJzdHJpbmdcIikge1xuICAgICAgICAgICAgcmVzcCA9IEpTT04ucGFyc2UoZXZlbnQuZGF0YSk7XG4gICAgICAgICAgfVxuICAgICAgICB9IGNhdGNoIChfKSB7XG4gICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG4gICAgICAgIGlmIChyZXNwLnJlcUlkID09PSBpZCkge1xuICAgICAgICAgIHJlc29sdmUocmVzcC5hY3Rpb25IYXNoKTtcbiAgICAgICAgfVxuICAgICAgfTtcbiAgICB9KTtcbiAgfVxuXG4gIHB1YmxpYyBhc3luYyBnZXRBY2NvdW50KGFkZHJlc3M6IHN0cmluZyk6IFByb21pc2U8QWNjb3VudD4ge1xuICAgIGNvbnN0IGFjY3QgPSBuZXcgQWNjb3VudCgpO1xuICAgIGFjY3QuYWRkcmVzcyA9IGFkZHJlc3M7XG4gICAgcmV0dXJuIGFjY3Q7XG4gIH1cblxuICBwdWJsaWMgYXN5bmMgZ2V0QWNjb3VudHMoKTogUHJvbWlzZTxBcnJheTxBY2NvdW50Pj4ge1xuICAgIGNvbnN0IGlkID0gcmVxSWQrKztcbiAgICBjb25zdCByZXEgPSB7XG4gICAgICByZXFJZDogaWQsXG4gICAgICB0eXBlOiBcIkdFVF9BQ0NPVU5UU1wiXG4gICAgfTtcbiAgICB0aGlzLnNlbmQocmVxKTtcbiAgICAvLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmU6cHJvbWlzZS1tdXN0LWNvbXBsZXRlXG4gICAgcmV0dXJuIG5ldyBQcm9taXNlPEFycmF5PEFjY291bnQ+PihyZXNvbHZlID0+IHtcbiAgICAgIHRoaXMud3Mub25tZXNzYWdlID0gZXZlbnQgPT4ge1xuICAgICAgICBsZXQgcmVzcCA9IHsgcmVxSWQ6IC0xLCBhY2NvdW50czogW10gfTtcbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICBpZiAodHlwZW9mIGV2ZW50LmRhdGEgPT09IFwic3RyaW5nXCIpIHtcbiAgICAgICAgICAgIHJlc3AgPSBKU09OLnBhcnNlKGV2ZW50LmRhdGEpO1xuICAgICAgICAgIH1cbiAgICAgICAgfSBjYXRjaCAoXykge1xuICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuICAgICAgICBpZiAocmVzcC5yZXFJZCA9PT0gaWQpIHtcbiAgICAgICAgICByZXNvbHZlKHJlc3AuYWNjb3VudHMpO1xuICAgICAgICB9XG4gICAgICB9O1xuICAgIH0pO1xuICB9XG5cbiAgcHVibGljIGdldE9yaWdpbihwbHVnaW46IHN0cmluZyA9IFwiXCIpOiBzdHJpbmcge1xuICAgIGxldCBvcmlnaW46IHN0cmluZyA9IFwiXCI7XG4gICAgaWYgKFxuICAgICAgbG9jYXRpb24gIT09IHVuZGVmaW5lZCAmJlxuICAgICAgbG9jYXRpb24uaGFzT3duUHJvcGVydHkoXCJob3N0bmFtZVwiKSAmJlxuICAgICAgbG9jYXRpb24uaG9zdG5hbWUubGVuZ3RoXG4gICAgKSB7XG4gICAgICBvcmlnaW4gPSBsb2NhdGlvbi5ob3N0bmFtZTtcbiAgICB9IGVsc2Uge1xuICAgICAgb3JpZ2luID0gcGx1Z2luO1xuICAgIH1cblxuICAgIGlmIChvcmlnaW4uc3Vic3RyKDAsIDQpID09PSBcInd3dy5cIikge1xuICAgICAgb3JpZ2luID0gb3JpZ2luLnJlcGxhY2UoXCJ3d3cuXCIsIFwiXCIpO1xuICAgIH1cbiAgICByZXR1cm4gb3JpZ2luO1xuICB9XG59XG4iXX0=
"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.XRC20 = void 0;

var _bignumber = _interopRequireDefault(require("bignumber.js"));

var _ethereumjsAbi = _interopRequireDefault(require("ethereumjs-abi"));

var _abiToByte = require("../contract/abi-to-byte");

var _contract = require("../contract/contract");

var _address = require("../crypto/address");

var _abi = require("./abi");

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

function _defineProperty(obj, key, value) { if (key in obj) { Object.defineProperty(obj, key, { value: value, enumerable: true, configurable: true, writable: true }); } else { obj[key] = value; } return obj; }

class XRC20 {
  constructor(address, options) {
    _defineProperty(this, "address", void 0);

    _defineProperty(this, "contract", void 0);

    _defineProperty(this, "methods", void 0);

    _defineProperty(this, "tokenName", void 0);

    _defineProperty(this, "tokenSymbol", void 0);

    _defineProperty(this, "tokenDecimals", void 0);

    _defineProperty(this, "tokenTotalSupply", void 0);

    this.address = address;
    this.contract = new _contract.Contract(_abi.XRC20_ABI, address, options);
    const methods = {}; // @ts-ignore

    for (const fnName of Object.keys(this.contract.getABI())) {
      // @ts-ignore
      const fnAbi = this.contract.getABI()[fnName];

      if (fnAbi.type === "constructor") {
        continue;
      }

      const args = (0, _abiToByte.getArgTypes)(fnAbi);
      const header = (0, _abiToByte.getHeaderHash)(fnAbi, args); // @ts-ignore

      methods[header] = {
        name: fnName,
        inputsNames: args.map(i => {
          return `${i.name}`;
        }),
        inputsTypes: args.map(i => {
          return `${i.type}`;
        })
      };
    }

    this.methods = methods;
  }

  async name() {
    if (this.tokenName) {
      return this.tokenName;
    }

    const result = await this.readMethod("name", this.address);

    const data = _ethereumjsAbi.default.rawDecode(["string"], Buffer.from(result, "hex"));

    if (data.length > 0) {
      this.tokenName = data[0];
      return this.tokenName;
    }

    return "";
  }

  async symbol() {
    if (this.tokenSymbol) {
      return this.tokenSymbol;
    }

    const result = await this.readMethod("symbol", this.address);

    const data = _ethereumjsAbi.default.rawDecode(["string"], Buffer.from(result, "hex"));

    if (data.length > 0) {
      this.tokenSymbol = data[0];
      return this.tokenSymbol;
    }

    return "";
  }

  async decimals() {
    if (this.tokenDecimals) {
      return this.tokenDecimals;
    }

    const result = await this.readMethod("decimals", this.address);
    this.tokenDecimals = new _bignumber.default(result, 16);
    return this.tokenDecimals;
  }

  async totalSupply() {
    if (this.tokenTotalSupply) {
      return this.tokenTotalSupply;
    }

    const result = await this.readMethod("totalSupply", this.address);
    this.tokenTotalSupply = new _bignumber.default(result, 16);
    return this.tokenTotalSupply;
  }

  async balanceOf(owner) {
    const result = await this.readMethod("balanceOf", this.address, owner);
    return new _bignumber.default(result, 16);
  }

  async transfer(to, value, options) {
    return this.executeMethod("transfer", options.account, options.gasPrice, options.gasLimit, "0", to, value.toFixed(0));
  }

  async allowance(owner, spender, options) {
    return this.executeMethod("allowance", options.account, options.gasPrice, options.gasLimit, "0", owner, spender);
  }

  async approve(spender, value, options) {
    return this.executeMethod("approve", options.account, options.gasPrice, options.gasLimit, "0", spender, value.toFixed(0));
  }

  async transferFrom(from, to, value, options) {
    return this.executeMethod("transferFrom", options.account, options.gasPrice, options.gasLimit, "0", from, to, value.toFixed(0));
  }

  async readMethod(method, callerAddress, // @ts-ignore
  // tslint:disable-next-line: typedef
  ...args) {
    if (!this.contract.provider) {
      throw new Error("no rpc method provider specified");
    }

    const result = await this.contract.provider.readContract({
      execution: this.contract.pureEncodeMethod("0", method, ...args),
      callerAddress: callerAddress
    });
    return result.data;
  }

  executeMethod(method, account, gasPrice, gasLimit, amount, // @ts-ignore
  // tslint:disable-next-line: typedef
  ...args) {
    return this.contract.methods[method](...args, {
      account: account,
      amount: amount,
      gasLimit: gasLimit,
      gasPrice: gasPrice
    });
  }

  decode(data) {
    if (data.length < 8) {
      throw new Error("input data error");
    }

    const methodKey = data.substr(0, 8);
    const method = this.methods[methodKey];

    if (!method) {
      throw new Error(`method ${methodKey} is not erc20 method`);
    }

    const params = _ethereumjsAbi.default.rawDecode(method.inputsTypes, Buffer.from(data.substring(8), "hex"));

    const values = {};

    for (let i = 0; i < method.inputsTypes.length; i++) {
      if (method.inputsTypes[i] === "address") {
        params[i] = (0, _address.fromBytes)(Buffer.from(params[i].toString(), "hex")).string();
      } // @ts-ignore


      values[method.inputsNames[i]] = params[i];
    }

    return {
      method: method.name,
      data: values
    };
  }

}

exports.XRC20 = XRC20;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy90b2tlbi94cmMyMC50cyJdLCJuYW1lcyI6WyJYUkMyMCIsImNvbnN0cnVjdG9yIiwiYWRkcmVzcyIsIm9wdGlvbnMiLCJjb250cmFjdCIsIkNvbnRyYWN0IiwiWFJDMjBfQUJJIiwibWV0aG9kcyIsImZuTmFtZSIsIk9iamVjdCIsImtleXMiLCJnZXRBQkkiLCJmbkFiaSIsInR5cGUiLCJhcmdzIiwiaGVhZGVyIiwibmFtZSIsImlucHV0c05hbWVzIiwibWFwIiwiaSIsImlucHV0c1R5cGVzIiwidG9rZW5OYW1lIiwicmVzdWx0IiwicmVhZE1ldGhvZCIsImRhdGEiLCJldGhlcmV1bWpzIiwicmF3RGVjb2RlIiwiQnVmZmVyIiwiZnJvbSIsImxlbmd0aCIsInN5bWJvbCIsInRva2VuU3ltYm9sIiwiZGVjaW1hbHMiLCJ0b2tlbkRlY2ltYWxzIiwiQmlnTnVtYmVyIiwidG90YWxTdXBwbHkiLCJ0b2tlblRvdGFsU3VwcGx5IiwiYmFsYW5jZU9mIiwib3duZXIiLCJ0cmFuc2ZlciIsInRvIiwidmFsdWUiLCJleGVjdXRlTWV0aG9kIiwiYWNjb3VudCIsImdhc1ByaWNlIiwiZ2FzTGltaXQiLCJ0b0ZpeGVkIiwiYWxsb3dhbmNlIiwic3BlbmRlciIsImFwcHJvdmUiLCJ0cmFuc2ZlckZyb20iLCJtZXRob2QiLCJjYWxsZXJBZGRyZXNzIiwicHJvdmlkZXIiLCJFcnJvciIsInJlYWRDb250cmFjdCIsImV4ZWN1dGlvbiIsInB1cmVFbmNvZGVNZXRob2QiLCJhbW91bnQiLCJkZWNvZGUiLCJtZXRob2RLZXkiLCJzdWJzdHIiLCJwYXJhbXMiLCJzdWJzdHJpbmciLCJ2YWx1ZXMiLCJ0b1N0cmluZyIsInN0cmluZyJdLCJtYXBwaW5ncyI6Ijs7Ozs7OztBQUFBOztBQUNBOztBQUVBOztBQUNBOztBQUNBOztBQUNBOzs7Ozs7QUFvQk8sTUFBTUEsS0FBTixDQUFZO0FBU2pCQyxFQUFBQSxXQUFXLENBQUNDLE9BQUQsRUFBa0JDLE9BQWxCLEVBQXFD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QyxNQUFNLENBQUMvQixXQUFQLENBQW1CUyxNQUF2QyxFQUErQ1YsQ0FBQyxFQUFoRCxFQUFvRDtBQUNsRCxVQUFJZ0MsTUFBTSxDQUFDL0IsV0FBUCxDQUFtQkQsQ0FBbkIsTUFBMEIsU0FBOUIsRUFBeUM7QUFDdkMyQyxRQUFBQSxNQUFNLENBQUMzQyxDQUFELENBQU4sR0FBWSx3QkFDVlEsTUFBTSxDQUFDQyxJQUFQLENBQVlrQyxNQUFNLENBQUMzQyxDQUFELENBQU4sQ0FBVThDLFFBQVYsRUFBWixFQUFrQyxLQUFsQyxDQURVLEVBRVZDLE1BRlUsRUFBWjtBQUdELE9BTGlELENBTWxEOzs7QUFDQUYsTUFBQUEsTUFBTSxDQUFDYixNQUFNLENBQUNsQyxXQUFQLENBQW1CRSxDQUFuQixDQUFELENBQU4sR0FBZ0MyQyxNQUFNLENBQUMzQyxDQUFELENBQXRDO0FBQ0Q7O0FBRUQsV0FBTztBQUNMZ0MsTUFBQUEsTUFBTSxFQUFFQSxNQUFNLENBQUNuQyxJQURWO0FBRUxRLE1BQUFBLElBQUksRUFBRXdDO0FBRkQsS0FBUDtBQUlEOztBQTVOZ0IiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgQmlnTnVtYmVyIGZyb20gXCJiaWdudW1iZXIuanNcIjtcbmltcG9ydCBldGhlcmV1bWpzIGZyb20gXCJldGhlcmV1bWpzLWFiaVwiO1xuaW1wb3J0IHsgQWNjb3VudCB9IGZyb20gXCIuLi9hY2NvdW50L2FjY291bnRcIjtcbmltcG9ydCB7IGdldEFyZ1R5cGVzLCBnZXRIZWFkZXJIYXNoIH0gZnJvbSBcIi4uL2NvbnRyYWN0L2FiaS10by1ieXRlXCI7XG5pbXBvcnQgeyBDb250cmFjdCwgT3B0aW9ucyB9IGZyb20gXCIuLi9jb250cmFjdC9jb250cmFjdFwiO1xuaW1wb3J0IHsgZnJvbUJ5dGVzIH0gZnJvbSBcIi4uL2NyeXB0by9hZGRyZXNzXCI7XG5pbXBvcnQgeyBYUkMyMF9BQkkgfSBmcm9tIFwiLi9hYmlcIjtcblxuZXhwb3J0IGludGVyZmFjZSBNZXRob2Qge1xuICBuYW1lOiBzdHJpbmc7XG4gIGlucHV0c05hbWVzOiBbc3RyaW5nXTtcbiAgaW5wdXRzVHlwZXM6IFtzdHJpbmddO1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIERlY29kZURhdGEge1xuICBtZXRob2Q6IHN0cmluZztcbiAgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOiBuby1hbnlcbiAgZGF0YTogeyBba2V5OiBzdHJpbmddOiBhbnkgfTtcbn1cblxuZXhwb3J0IGludGVyZmFjZSBFeGVjdXRlT3B0aW9uIHtcbiAgYWNjb3VudDogQWNjb3VudDtcbiAgZ2FzUHJpY2U6IHN0cmluZztcbiAgZ2FzTGltaXQ6IHN0cmluZztcbn1cblxuZXhwb3J0IGNsYXNzIFhSQzIwIHtcbiAgcHVibGljIGFkZHJlc3M6IHN0cmluZztcbiAgcHJpdmF0ZSByZWFkb25seSBjb250cmFjdDogQ29udHJhY3Q7XG4gIHByaXZhdGUgcmVhZG9ubHkgbWV0aG9kczogeyBba2V5OiBzdHJpbmddOiBNZXRob2QgfTtcbiAgcHJpdmF0ZSB0b2tlbk5hbWU6IHN0cmluZztcbiAgcHJpdmF0ZSB0b2tlblN5bWJvbDogc3RyaW5nO1xuICBwcml2YXRlIHRva2VuRGVjaW1hbHM6IEJpZ051bWJlcjtcbiAgcHJpdmF0ZSB0b2tlblRvdGFsU3VwcGx5OiBCaWdOdW1iZXI7XG5cbiAgY29uc3RydWN0b3IoYWRkcmVzczogc3RyaW5nLCBvcHRpb25zPzogT3B0aW9ucykge1xuICAgIHRoaXMuYWRkcmVzcyA9IGFkZHJlc3M7XG4gICAgdGhpcy5jb250cmFjdCA9IG5ldyBDb250cmFjdChYUkMyMF9BQkksIGFkZHJlc3MsIG9wdGlvbnMpO1xuXG4gICAgY29uc3QgbWV0aG9kcyA9IHt9O1xuICAgIC8vIEB0cy1pZ25vcmVcbiAgICBmb3IgKGNvbnN0IGZuTmFtZSBvZiBPYmplY3Qua2V5cyh0aGlzLmNvbnRyYWN0LmdldEFCSSgpKSkge1xuICAgICAgLy8gQHRzLWlnbm9yZVxuICAgICAgY29uc3QgZm5BYmkgPSB0aGlzLmNvbnRyYWN0LmdldEFCSSgpW2ZuTmFtZV07XG4gICAgICBpZiAoZm5BYmkudHlwZSA9PT0gXCJjb25zdHJ1Y3RvclwiKSB7XG4gICAgICAgIGNvbnRpbnVlO1xuICAgICAgfVxuXG4gICAgICBjb25zdCBhcmdzID0gZ2V0QXJnVHlwZXMoZm5BYmkpO1xuICAgICAgY29uc3QgaGVhZGVyID0gZ2V0SGVhZGVySGFzaChmbkFiaSwgYXJncyk7XG5cbiAgICAgIC8vIEB0cy1pZ25vcmVcbiAgICAgIG1ldGhvZHNbaGVhZGVyXSA9IHtcbiAgICAgICAgbmFtZTogZm5OYW1lLFxuICAgICAgICBpbnB1dHNOYW1lczogYXJncy5tYXAoaSA9PiB7XG4gICAgICAgICAgcmV0dXJuIGAke2kubmFtZX1gO1xuICAgICAgICB9KSxcbiAgICAgICAgaW5wdXRzVHlwZXM6IGFyZ3MubWFwKGkgPT4ge1xuICAgICAgICAgIHJldHVybiBgJHtpLnR5cGV9YDtcbiAgICAgICAgfSlcbiAgICAgIH07XG4gICAgfVxuICAgIHRoaXMubWV0aG9kcyA9IG1ldGhvZHM7XG4gIH1cblxuICBwdWJsaWMgYXN5bmMgbmFtZSgpOiBQcm9taXNlPHN0cmluZz4ge1xuICAgIGlmICh0aGlzLnRva2VuTmFtZSkge1xuICAgICAgcmV0dXJuIHRoaXMudG9rZW5OYW1lO1xuICAgIH1cbiAgICBjb25zdCByZXN1bHQgPSBhd2FpdCB0aGlzLnJlYWRNZXRob2QoXCJuYW1lXCIsIHRoaXMuYWRkcmVzcyk7XG4gICAgY29uc3QgZGF0YSA9IGV0aGVyZXVtanMucmF3RGVjb2RlKFtcInN0cmluZ1wiXSwgQnVmZmVyLmZyb20ocmVzdWx0LCBcImhleFwiKSk7XG4gICAgaWYgKGRhdGEubGVuZ3RoID4gMCkge1xuICAgICAgdGhpcy50b2tlbk5hbWUgPSBkYXRhWzBdO1xuICAgICAgcmV0dXJuIHRoaXMudG9rZW5OYW1lO1xuICAgIH1cbiAgICByZXR1cm4gXCJcIjtcbiAgfVxuXG4gIHB1YmxpYyBhc3luYyBzeW1ib2woKTogUHJvbWlzZTxzdHJpbmc+IHtcbiAgICBpZiAodGhpcy50b2tlblN5bWJvbCkge1xuICAgICAgcmV0dXJuIHRoaXMudG9rZW5TeW1ib2w7XG4gICAgfVxuICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IHRoaXMucmVhZE1ldGhvZChcInN5bWJvbFwiLCB0aGlzLmFkZHJlc3MpO1xuICAgIGNvbnN0IGRhdGEgPSBldGhlcmV1bWpzLnJhd0RlY29kZShbXCJzdHJpbmdcIl0sIEJ1ZmZlci5mcm9tKHJlc3VsdCwgXCJoZXhcIikpO1xuICAgIGlmIChkYXRhLmxlbmd0aCA+IDApIHtcbiAgICAgIHRoaXMudG9rZW5TeW1ib2wgPSBkYXRhWzBdO1xuICAgICAgcmV0dXJuIHRoaXMudG9rZW5TeW1ib2w7XG4gICAgfVxuICAgIHJldHVybiBcIlwiO1xuICB9XG5cbiAgcHVibGljIGFzeW5jIGRlY2ltYWxzKCk6IFByb21pc2U8QmlnTnVtYmVyPiB7XG4gICAgaWYgKHRoaXMudG9rZW5EZWNpbWFscykge1xuICAgICAgcmV0dXJuIHRoaXMudG9rZW5EZWNpbWFscztcbiAgICB9XG4gICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgdGhpcy5yZWFkTWV0aG9kKFwiZGVjaW1hbHNcIiwgdGhpcy5hZGRyZXNzKTtcbiAgICB0aGlzLnRva2VuRGVjaW1hbHMgPSBuZXcgQmlnTnVtYmVyKHJlc3VsdCwgMTYpO1xuICAgIHJldHVybiB0aGlzLnRva2VuRGVjaW1hbHM7XG4gIH1cblxuICBwdWJsaWMgYXN5bmMgdG90YWxTdXBwbHkoKTogUHJvbWlzZTxCaWdOdW1iZXI+IHtcbiAgICBpZiAodGhpcy50b2tlblRvdGFsU3VwcGx5KSB7XG4gICAgICByZXR1cm4gdGhpcy50b2tlblRvdGFsU3VwcGx5O1xuICAgIH1cbiAgICBjb25zdCByZXN1bHQgPSBhd2FpdCB0aGlzLnJlYWRNZXRob2QoXCJ0b3RhbFN1cHBseVwiLCB0aGlzLmFkZHJlc3MpO1xuICAgIHRoaXMudG9rZW5Ub3RhbFN1cHBseSA9IG5ldyBCaWdOdW1iZXIocmVzdWx0LCAxNik7XG4gICAgcmV0dXJuIHRoaXMudG9rZW5Ub3RhbFN1cHBseTtcbiAgfVxuXG4gIHB1YmxpYyBhc3luYyBiYWxhbmNlT2Yob3duZXI6IHN0cmluZyk6IFByb21pc2U8QmlnTnVtYmVyPiB7XG4gICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgdGhpcy5yZWFkTWV0aG9kKFwiYmFsYW5jZU9mXCIsIHRoaXMuYWRkcmVzcywgb3duZXIpO1xuICAgIHJldHVybiBuZXcgQmlnTnVtYmVyKHJlc3VsdCwgMTYpO1xuICB9XG5cbiAgcHVibGljIGFzeW5jIHRyYW5zZmVyKFxuICAgIHRvOiBzdHJpbmcsXG4gICAgdmFsdWU6IEJpZ051bWJlcixcbiAgICBvcHRpb25zOiBFeGVjdXRlT3B0aW9uXG4gICk6IFByb21pc2U8c3RyaW5nPiB7XG4gICAgcmV0dXJuIHRoaXMuZXhlY3V0ZU1ldGhvZChcbiAgICAgIFwidHJhbnNmZXJcIixcbiAgICAgIG9wdGlvbnMuYWNjb3VudCxcbiAgICAgIG9wdGlvbnMuZ2FzUHJpY2UsXG4gICAgICBvcHRpb25zLmdhc0xpbWl0LFxuICAgICAgXCIwXCIsXG4gICAgICB0byxcbiAgICAgIHZhbHVlLnRvRml4ZWQoMClcbiAgICApO1xuICB9XG5cbiAgcHVibGljIGFzeW5jIGFsbG93YW5jZShcbiAgICBvd25lcjogc3RyaW5nLFxuICAgIHNwZW5kZXI6IHN0cmluZyxcbiAgICBvcHRpb25zOiBFeGVjdXRlT3B0aW9uXG4gICk6IFByb21pc2U8c3RyaW5nPiB7XG4gICAgcmV0dXJuIHRoaXMuZXhlY3V0ZU1ldGhvZChcbiAgICAgIFwiYWxsb3dhbmNlXCIsXG4gICAgICBvcHRpb25zLmFjY291bnQsXG4gICAgICBvcHRpb25zLmdhc1ByaWNlLFxuICAgICAgb3B0aW9ucy5nYXNMaW1pdCxcbiAgICAgIFwiMFwiLFxuICAgICAgb3duZXIsXG4gICAgICBzcGVuZGVyXG4gICAgKTtcbiAgfVxuXG4gIHB1YmxpYyBhc3luYyBhcHByb3ZlKFxuICAgIHNwZW5kZXI6IHN0cmluZyxcbiAgICB2YWx1ZTogQmlnTnVtYmVyLFxuICAgIG9wdGlvbnM6IEV4ZWN1dGVPcHRpb25cbiAgKTogUHJvbWlzZTxzdHJpbmc+IHtcbiAgICByZXR1cm4gdGhpcy5leGVjdXRlTWV0aG9kKFxuICAgICAgXCJhcHByb3ZlXCIsXG4gICAgICBvcHRpb25zLmFjY291bnQsXG4gICAgICBvcHRpb25zLmdhc1ByaWNlLFxuICAgICAgb3B0aW9ucy5nYXNMaW1pdCxcbiAgICAgIFwiMFwiLFxuICAgICAgc3BlbmRlcixcbiAgICAgIHZhbHVlLnRvRml4ZWQoMClcbiAgICApO1xuICB9XG5cbiAgcHVibGljIGFzeW5jIHRyYW5zZmVyRnJvbShcbiAgICBmcm9tOiBzdHJpbmcsXG4gICAgdG86IHN0cmluZyxcbiAgICB2YWx1ZTogQmlnTnVtYmVyLFxuICAgIG9wdGlvbnM6IEV4ZWN1dGVPcHRpb25cbiAgKTogUHJvbWlzZTxzdHJpbmc+IHtcbiAgICByZXR1cm4gdGhpcy5leGVjdXRlTWV0aG9kKFxuICAgICAgXCJ0cmFuc2ZlckZyb21cIixcbiAgICAgIG9wdGlvbnMuYWNjb3VudCxcbiAgICAgIG9wdGlvbnMuZ2FzUHJpY2UsXG4gICAgICBvcHRpb25zLmdhc0xpbWl0LFxuICAgICAgXCIwXCIsXG4gICAgICBmcm9tLFxuICAgICAgdG8sXG4gICAgICB2YWx1ZS50b0ZpeGVkKDApXG4gICAgKTtcbiAgfVxuXG4gIHByaXZhdGUgYXN5bmMgcmVhZE1ldGhvZChcbiAgICBtZXRob2Q6IHN0cmluZyxcbiAgICBjYWxsZXJBZGRyZXNzOiBzdHJpbmcsXG4gICAgLy8gQHRzLWlnbm9yZVxuICAgIC8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTogdHlwZWRlZlxuICAgIC4uLmFyZ3NcbiAgKTogUHJvbWlzZTxzdHJpbmc+IHtcbiAgICBpZiAoIXRoaXMuY29udHJhY3QucHJvdmlkZXIpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihcIm5vIHJwYyBtZXRob2QgcHJvdmlkZXIgc3BlY2lmaWVkXCIpO1xuICAgIH1cblxuICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IHRoaXMuY29udHJhY3QucHJvdmlkZXIucmVhZENvbnRyYWN0KHtcbiAgICAgIGV4ZWN1dGlvbjogdGhpcy5jb250cmFjdC5wdXJlRW5jb2RlTWV0aG9kKFwiMFwiLCBtZXRob2QsIC4uLmFyZ3MpLFxuICAgICAgY2FsbGVyQWRkcmVzczogY2FsbGVyQWRkcmVzc1xuICAgIH0pO1xuXG4gICAgcmV0dXJuIHJlc3VsdC5kYXRhO1xuICB9XG5cbiAgcHJpdmF0ZSBleGVjdXRlTWV0aG9kKFxuICAgIG1ldGhvZDogc3RyaW5nLFxuICAgIGFjY291bnQ6IEFjY291bnQsXG4gICAgZ2FzUHJpY2U6IHN0cmluZyxcbiAgICBnYXNMaW1pdDogc3RyaW5nLFxuICAgIGFtb3VudDogc3RyaW5nLFxuICAgIC8vIEB0cy1pZ25vcmVcbiAgICAvLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmU6IHR5cGVkZWZcbiAgICAuLi5hcmdzXG4gICk6IHN0cmluZyB7XG4gICAgcmV0dXJuIHRoaXMuY29udHJhY3QubWV0aG9kc1ttZXRob2RdKC4uLmFyZ3MsIHtcbiAgICAgIGFjY291bnQ6IGFjY291bnQsXG4gICAgICBhbW91bnQ6IGFtb3VudCxcbiAgICAgIGdhc0xpbWl0OiBnYXNMaW1pdCxcbiAgICAgIGdhc1ByaWNlOiBnYXNQcmljZVxuICAgIH0pO1xuICB9XG5cbiAgcHVibGljIGRlY29kZShkYXRhOiBzdHJpbmcpOiBEZWNvZGVEYXRhIHtcbiAgICBpZiAoZGF0YS5sZW5ndGggPCA4KSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoXCJpbnB1dCBkYXRhIGVycm9yXCIpO1xuICAgIH1cbiAgICBjb25zdCBtZXRob2RLZXkgPSBkYXRhLnN1YnN0cigwLCA4KTtcbiAgICBjb25zdCBtZXRob2QgPSB0aGlzLm1ldGhvZHNbbWV0aG9kS2V5XTtcbiAgICBpZiAoIW1ldGhvZCkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGBtZXRob2QgJHttZXRob2RLZXl9IGlzIG5vdCBlcmMyMCBtZXRob2RgKTtcbiAgICB9XG4gICAgY29uc3QgcGFyYW1zID0gZXRoZXJldW1qcy5yYXdEZWNvZGUoXG4gICAgICBtZXRob2QuaW5wdXRzVHlwZXMsXG4gICAgICBCdWZmZXIuZnJvbShkYXRhLnN1YnN0cmluZyg4KSwgXCJoZXhcIilcbiAgICApO1xuICAgIGNvbnN0IHZhbHVlcyA9IHt9O1xuXG4gICAgZm9yIChsZXQgaSA9IDA7IGkgPCBtZXRob2QuaW5wdXRzVHlwZXMubGVuZ3RoOyBpKyspIHtcbiAgICAgIGlmIChtZXRob2QuaW5wdXRzVHlwZXNbaV0gPT09IFwiYWRkcmVzc1wiKSB7XG4gICAgICAgIHBhcmFtc1tpXSA9IGZyb21CeXRlcyhcbiAgICAgICAgICBCdWZmZXIuZnJvbShwYXJhbXNbaV0udG9TdHJpbmcoKSwgXCJoZXhcIilcbiAgICAgICAgKS5zdHJpbmcoKTtcbiAgICAgIH1cbiAgICAgIC8vIEB0cy1pZ25vcmVcbiAgICAgIHZhbHVlc1ttZXRob2QuaW5wdXRzTmFtZXNbaV1dID0gcGFyYW1zW2ldO1xuICAgIH1cblxuICAgIHJldHVybiB7XG4gICAgICBtZXRob2Q6IG1ldGhvZC5uYW1lLFxuICAgICAgZGF0YTogdmFsdWVzXG4gICAgfTtcbiAgfVxufVxuIl19
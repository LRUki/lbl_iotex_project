"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.ClaimFromRewardingFundMethod = exports.ExecutionMethod = exports.TransferMethod = exports.AbstractMethod = void 0;

var _bignumber = _interopRequireDefault(require("bignumber.js"));

var _envelop = require("./envelop");

var _types = require("./types");

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

function _defineProperty(obj, key, value) { if (key in obj) { Object.defineProperty(obj, key, { value: value, enumerable: true, configurable: true, writable: true }); } else { obj[key] = value; } return obj; }

class AbstractMethod {
  constructor(client, account, opts) {
    _defineProperty(this, "client", void 0);

    _defineProperty(this, "account", void 0);

    _defineProperty(this, "signer", void 0);

    this.client = client;
    this.account = account;
    this.signer = opts && opts.signer;
  }

  async baseEnvelop(gasLimit, gasPrice) {
    let nonce = "";

    if (this.account && this.account.address) {
      const meta = await this.client.getAccount({
        address: this.account.address
      });
      nonce = String(meta.accountMeta && meta.accountMeta.pendingNonce || "");
    }

    return new _envelop.Envelop(1, nonce, gasLimit, gasPrice);
  }

  async signAction(envelop) {
    if (!envelop.gasPrice) {
      const price = await this.client.suggestGasPrice({});
      envelop.gasPrice = String(price.gasPrice);
    }

    if (!envelop.gasLimit) {
      const limit = await this.client.estimateActionGasConsumption({
        transfer: envelop.transfer,
        execution: envelop.execution,
        callerAddress: this.account.address
      });
      envelop.gasLimit = limit.gas.toString();
    }

    if (this.account && this.account.address) {
      const meta = await this.client.getAccount({
        address: this.account.address
      });

      if (meta.accountMeta && meta.accountMeta.balance) {
        const gasPrice = new _bignumber.default(envelop.gasPrice);
        const gasLimit = new _bignumber.default(envelop.gasLimit);
        const balance = new _bignumber.default(meta.accountMeta.balance);

        if (envelop.transfer) {
          const amount = new _bignumber.default(envelop.transfer.amount);

          if (balance.comparedTo(amount.plus(gasPrice.multipliedBy(gasLimit))) < 0) {
            throw new _types.ActionError(_types.ActionErrorCode.ErrBalance, "Insufficient funds for gas * price + amount");
          }
        }

        if (envelop.execution) {
          const amount = new _bignumber.default(envelop.execution.amount);

          if (balance.comparedTo(amount.plus(gasPrice.multipliedBy(gasLimit))) < 0) {
            throw new _types.ActionError(_types.ActionErrorCode.ErrBalance, "Insufficient funds for gas * price + amount");
          }
        }
      }
    }

    return _envelop.SealedEnvelop.sign(this.account.privateKey, this.account.publicKey, envelop);
  }

  async sendAction(envelop) {
    const opts = {
      address: ""
    };

    if (this.account && this.account.address) {
      opts.address = this.account.address;
    }

    if (this.signer && this.signer.signAndSend) {
      return this.signer.signAndSend(envelop, opts);
    }

    let selp;

    if (this.signer && this.signer.signOnly) {
      selp = await this.signer.signOnly(envelop, opts);
    } else {
      selp = await this.signAction(envelop);
    }

    try {
      await this.client.sendAction({
        action: selp.action()
      });
    } catch (e) {
      let code = _types.ActionErrorCode.ErrUnknown;
      let message = `send action error: ${JSON.stringify(e)}`;

      if (e.details) {
        message = e.details;

        if (e.details.match(/^reject existed action .*/)) {
          code = _types.ActionErrorCode.ErrExistedAction;
        } else if (e.details.match(/^insufficient balance .*/)) {
          code = _types.ActionErrorCode.ErrBalance;
        } else if (e.details.match(/.* lower than minimal gas price threshold$/)) {
          code = _types.ActionErrorCode.ErrGasPrice;
        } else if (e.details === "action source address is blacklisted") {
          code = _types.ActionErrorCode.ErrAddress;
        } else if (e.details.indexOf("nonce") >= 0) {
          code = _types.ActionErrorCode.ErrNonce;
        }
      }

      throw new _types.ActionError(code, message);
    }

    return selp.hash();
  }

}

exports.AbstractMethod = AbstractMethod;

class TransferMethod extends AbstractMethod {
  constructor(client, account, transfer, opts) {
    super(client, account, opts);

    _defineProperty(this, "transfer", void 0);

    this.transfer = transfer;
  }

  async execute() {
    const envelop = await this.baseEnvelop(this.transfer.gasLimit, this.transfer.gasPrice);
    envelop.transfer = {
      amount: this.transfer.amount,
      recipient: this.transfer.recipient,
      payload: Buffer.from(this.transfer.payload, "hex")
    };
    return this.sendAction(envelop);
  }

}

exports.TransferMethod = TransferMethod;

class ExecutionMethod extends AbstractMethod {
  constructor(client, account, execution, opts) {
    super(client, account, opts);

    _defineProperty(this, "execution", void 0);

    this.execution = execution;
  }

  async execute() {
    const envelop = await this.baseEnvelop(this.execution.gasLimit, this.execution.gasPrice);
    envelop.execution = {
      amount: this.execution.amount,
      contract: this.execution.contract,
      data: this.execution.data
    };
    return this.sendAction(envelop);
  }

  async sign() {
    const envelop = await this.baseEnvelop(this.execution.gasLimit, this.execution.gasPrice);
    envelop.execution = {
      amount: this.execution.amount,
      contract: this.execution.contract,
      data: this.execution.data
    };
    const selp = await this.signAction(envelop);
    return selp.action();
  }

}

exports.ExecutionMethod = ExecutionMethod;

class ClaimFromRewardingFundMethod extends AbstractMethod {
  constructor(client, account, claim, opts) {
    super(client, account, opts);

    _defineProperty(this, "claimFronRewardFund", void 0);

    this.claimFronRewardFund = claim;
  }

  async execute() {
    const envelop = await this.baseEnvelop(this.claimFronRewardFund.gasLimit, this.claimFronRewardFund.gasPrice);
    envelop.claimFromRewardingFund = {
      amount: this.claimFronRewardFund.amount,
      data: this.claimFronRewardFund.data
    };
    return this.sendAction(envelop);
  }

  async sign() {
    const envelop = await this.baseEnvelop(this.claimFronRewardFund.gasLimit, this.claimFronRewardFund.gasPrice);
    envelop.claimFromRewardingFund = {
      amount: this.claimFronRewardFund.amount,
      data: this.claimFronRewardFund.data
    };
    const selp = await this.signAction(envelop);
    return selp.action();
  }

}

exports.ClaimFromRewardingFundMethod = ClaimFromRewardingFundMethod;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9hY3Rpb24vbWV0aG9kLnRzIl0sIm5hbWVzIjpbIkFic3RyYWN0TWV0aG9kIiwiY29uc3RydWN0b3IiLCJjbGllbnQiLCJhY2NvdW50Iiwib3B0cyIsInNpZ25lciIsImJhc2VFbnZlbG9wIiwiZ2FzTGltaXQiLCJnYXNQcmljZSIsIm5vbmNlIiwiYWRkcmVzcyIsIm1ldGEiLCJnZXRBY2NvdW50IiwiU3RyaW5nIiwiYWNjb3VudE1ldGEiLCJwZW5kaW5nTm9uY2UiLCJFbnZlbG9wIiwic2lnbkFjdGlvbiIsImVudmVsb3AiLCJwcmljZSIsInN1Z2dlc3RHYXNQcmljZSIsImxpbWl0IiwiZXN0aW1hdGVBY3Rpb25HYXNDb25zdW1wdGlvbiIsInRyYW5zZmVyIiwiZXhlY3V0aW9uIiwiY2FsbGVyQWRkcmVzcyIsImdhcyIsInRvU3RyaW5nIiwiYmFsYW5jZSIsIkJpZ051bWJlciIsImFtb3VudCIsImNvbXBhcmVkVG8iLCJwbHVzIiwibXVsdGlwbGllZEJ5IiwiQWN0aW9uRXJyb3IiLCJBY3Rpb25FcnJvckNvZGUiLCJFcnJCYWxhbmNlIiwiU2VhbGVkRW52ZWxvcCIsInNpZ24iLCJwcml2YXRlS2V5IiwicHVibGljS2V5Iiwic2VuZEFjdGlvbiIsInNpZ25BbmRTZW5kIiwic2VscCIsInNpZ25Pbmx5IiwiYWN0aW9uIiwiZSIsImNvZGUiLCJFcnJVbmtub3duIiwibWVzc2FnZSIsIkpTT04iLCJzdHJpbmdpZnkiLCJkZXRhaWxzIiwibWF0Y2giLCJFcnJFeGlzdGVkQWN0aW9uIiwiRXJyR2FzUHJpY2UiLCJFcnJBZGRyZXNzIiwiaW5kZXhPZiIsIkVyck5vbmNlIiwiaGFzaCIsIlRyYW5zZmVyTWV0aG9kIiwiZXhlY3V0ZSIsInJlY2lwaWVudCIsInBheWxvYWQiLCJCdWZmZXIiLCJmcm9tIiwiRXhlY3V0aW9uTWV0aG9kIiwiY29udHJhY3QiLCJkYXRhIiwiQ2xhaW1Gcm9tUmV3YXJkaW5nRnVuZE1ldGhvZCIsImNsYWltIiwiY2xhaW1G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QUksR0FBRyxNQUFNLEtBQUsxQixVQUFMLENBQWdCQyxPQUFoQixDQUFuQjtBQUNBLFdBQU95QixJQUFJLENBQUNFLE1BQUwsRUFBUDtBQUNEOztBQXRDOEQiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgQmlnTnVtYmVyIGZyb20gXCJiaWdudW1iZXIuanNcIjtcbmltcG9ydCB7IEFjY291bnQsIElBY2NvdW50IH0gZnJvbSBcIi4uL2FjY291bnQvYWNjb3VudFwiO1xuaW1wb3J0IHsgSUFjdGlvbiwgSVJwY01ldGhvZCB9IGZyb20gXCIuLi9ycGMtbWV0aG9kL3R5cGVzXCI7XG5pbXBvcnQgeyBFbnZlbG9wLCBTZWFsZWRFbnZlbG9wIH0gZnJvbSBcIi4vZW52ZWxvcFwiO1xuaW1wb3J0IHtcbiAgQWN0aW9uRXJyb3IsXG4gIEFjdGlvbkVycm9yQ29kZSxcbiAgQ2xhaW1Gcm9tUmV3YXJkaW5nRnVuZCxcbiAgRXhlY3V0aW9uLFxuICBUcmFuc2ZlclxufSBmcm9tIFwiLi90eXBlc1wiO1xuXG5leHBvcnQgaW50ZXJmYWNlIFBsdWdpbk9wdHMge1xuICBhZGRyZXNzOiBzdHJpbmc7XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgU2lnbmVyUGx1Z2luIHtcbiAgc2lnbkFuZFNlbmQ/KGVudmVsb3A6IEVudmVsb3AsIG9wdGlvbnM/OiBQbHVnaW5PcHRzKTogUHJvbWlzZTxzdHJpbmc+O1xuXG4gIHNpZ25Pbmx5PyhlbnZlbG9wOiBFbnZlbG9wLCBvcHRpb25zPzogUGx1Z2luT3B0cyk6IFByb21pc2U8U2VhbGVkRW52ZWxvcD47XG5cbiAgZ2V0QWNjb3VudD8oYWRkcmVzczogc3RyaW5nKTogUHJvbWlzZTxJQWNjb3VudD47XG5cbiAgZ2V0QWNjb3VudHM/KCk6IFByb21pc2U8QXJyYXk8SUFjY291bnQ+Pjtcbn1cblxuZXhwb3J0IHR5cGUgQWJzdHJhY3RNZXRob2RPcHRzID0geyBzaWduZXI/OiBTaWduZXJQbHVnaW4gfCB1bmRlZmluZWQgfTtcblxuZXhwb3J0IGNsYXNzIEFic3RyYWN0TWV0aG9kIHtcbiAgcHVibGljIGNsaWVudDogSVJwY01ldGhvZDtcbiAgcHVibGljIGFjY291bnQ6IEFjY291bnQ7XG4gIHB1YmxpYyBzaWduZXI/OiBTaWduZXJQbHVnaW47XG5cbiAgY29uc3RydWN0b3IoY2xpZW50OiBJUnBjTWV0aG9kLCBhY2NvdW50OiBBY2NvdW50LCBvcHRzPzogQWJzdHJhY3RNZXRob2RPcHRzKSB7XG4gICAgdGhpcy5jbGllbnQgPSBjbGllbnQ7XG4gICAgdGhpcy5hY2NvdW50ID0gYWNjb3VudDtcbiAgICB0aGlzLnNpZ25lciA9IG9wdHMgJiYgb3B0cy5zaWduZXI7XG4gIH1cblxuICBwdWJsaWMgYXN5bmMgYmFzZUVudmVsb3AoXG4gICAgZ2FzTGltaXQ/OiBzdHJpbmcsXG4gICAgZ2FzUHJpY2U/OiBzdHJpbmdcbiAgKTogUHJvbWlzZTxFbnZlbG9wPiB7XG4gICAgbGV0IG5vbmNlID0gXCJcIjtcbiAgICBpZiAodGhpcy5hY2NvdW50ICYmIHRoaXMuYWNjb3VudC5hZGRyZXNzKSB7XG4gICAgICBjb25zdCBtZXRhID0gYXdhaXQgdGhpcy5jbGllbnQuZ2V0QWNjb3VudCh7XG4gICAgICAgIGFkZHJlc3M6IHRoaXMuYWNjb3VudC5hZGRyZXNzXG4gICAgICB9KTtcbiAgICAgIG5vbmNlID0gU3RyaW5nKChtZXRhLmFjY291bnRNZXRhICYmIG1ldGEuYWNjb3VudE1ldGEucGVuZGluZ05vbmNlKSB8fCBcIlwiKTtcbiAgICB9XG5cbiAgICByZXR1cm4gbmV3IEVudmVsb3AoMSwgbm9uY2UsIGdhc0xpbWl0LCBnYXNQcmljZSk7XG4gIH1cblxuICBwdWJsaWMgYXN5bmMgc2lnbkFjdGlvbihlbnZlbG9wOiBFbnZlbG9wKTogUHJvbWlzZTxTZWFsZWRFbnZlbG9wPiB7XG4gICAgaWYgKCFlbnZlbG9wLmdhc1ByaWNlKSB7XG4gICAgICBjb25zdCBwcmljZSA9IGF3YWl0IHRoaXMuY2xpZW50LnN1Z2dlc3RHYXNQcmljZSh7fSk7XG4gICAgICBlbnZlbG9wLmdhc1ByaWNlID0gU3RyaW5nKHByaWNlLmdhc1ByaWNlKTtcbiAgICB9XG5cbiAgICBpZiAoIWVudmVsb3AuZ2FzTGltaXQpIHtcbiAgICAgIGNvbnN0IGxpbWl0ID0gYXdhaXQgdGhpcy5jbGllbnQuZXN0aW1hdGVBY3Rpb25HYXNDb25zdW1wdGlvbih7XG4gICAgICAgIHRyYW5zZmVyOiBlbnZlbG9wLnRyYW5zZmVyLFxuICAgICAgICBleGVjdXRpb246IGVudmVsb3AuZXhlY3V0aW9uLFxuICAgICAgICBjYWxsZXJBZGRyZXNzOiB0aGlzLmFjY291bnQuYWRkcmVzc1xuICAgICAgfSk7XG4gICAgICBlbnZlbG9wLmdhc0xpbWl0ID0gbGltaXQuZ2FzLnRvU3RyaW5nKCk7XG4gICAgfVxuXG4gICAgaWYgKHRoaXMuYWNjb3VudCAmJiB0aGlzLmFjY291bnQuYWRkcmVzcykge1xuICAgICAgY29uc3QgbWV0YSA9IGF3YWl0IHRoaXMuY2xpZW50LmdldEFjY291bnQoe1xuICAgICAgICBhZGRyZXNzOiB0aGlzLmFjY291bnQuYWRkcmVzc1xuICAgICAgfSk7XG4gICAgICBpZiAobWV0YS5hY2NvdW50TWV0YSAmJiBtZXRhLmFjY291bnRNZXRhLmJhbGFuY2UpIHtcbiAgICAgICAgY29uc3QgZ2FzUHJpY2UgPSBuZXcgQmlnTnVtYmVyKGVudmVsb3AuZ2FzUHJpY2UpO1xuICAgICAgICBjb25zdCBnYXNMaW1pdCA9IG5ldyBCaWdOdW1iZXIoZW52ZWxvcC5nYXNMaW1pdCk7XG4gICAgICAgIGNvbnN0IGJhbGFuY2UgPSBuZXcgQmlnTnVtYmVyKG1ldGEuYWNjb3VudE1ldGEuYmFsYW5jZSk7XG4gICAgICAgIGlmIChlbnZlbG9wLnRyYW5zZmVyKSB7XG4gICAgICAgICAgY29uc3QgYW1vdW50ID0gbmV3IEJpZ051bWJlcihlbnZlbG9wLnRyYW5zZmVyLmFtb3VudCk7XG4gICAgICAgICAgaWYgKFxuICAgICAgICAgICAgYmFsYW5jZS5jb21wYXJlZFRvKGFtb3VudC5wbHVzKGdhc1ByaWNlLm11bHRpcGxpZWRCeShnYXNMaW1pdCkpKSA8IDBcbiAgICAgICAgICApIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBBY3Rpb25FcnJvcihcbiAgICAgICAgICAgICAgQWN0aW9uRXJyb3JDb2RlLkVyckJhbGFuY2UsXG4gICAgICAgICAgICAgIFwiSW5zdWZmaWNpZW50IGZ1bmRzIGZvciBnYXMgKiBwcmljZSArIGFtb3VudFwiXG4gICAgICAgICAgICApO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICBpZiAoZW52ZWxvcC5leGVjdXRpb24pIHtcbiAgICAgICAgICBjb25zdCBhbW91bnQgPSBuZXcgQmlnTnVtYmVyKGVudmVsb3AuZXhlY3V0aW9uLmFtb3VudCk7XG4gICAgICAgICAgaWYgKFxuICAgICAgICAgICAgYmFsYW5jZS5jb21wYXJlZFRvKGFtb3VudC5wbHVzKGdhc1ByaWNlLm11bHRpcGxpZWRCeShnYXNMaW1pdCkpKSA8IDBcbiAgICAgICAgICApIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBBY3Rpb25FcnJvcihcbiAgICAgICAgICAgICAgQWN0aW9uRXJyb3JDb2RlLkVyckJhbGFuY2UsXG4gICAgICAgICAgICAgIFwiSW5zdWZmaWNpZW50IGZ1bmRzIGZvciBnYXMgKiBwcmljZSArIGFtb3VudFwiXG4gICAgICAgICAgICApO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cblxuICAgIHJldHVybiBTZWFsZWRFbnZlbG9wLnNpZ24oXG4gICAgICB0aGlzLmFjY291bnQucHJpdmF0ZUtleSxcbiAgICAgIHRoaXMuYWNjb3VudC5wdWJsaWNLZXksXG4gICAgICBlbnZlbG9wXG4gICAgKTtcbiAgfVxuXG4gIHB1YmxpYyBhc3luYyBzZW5kQWN0aW9uKGVudmVsb3A6IEVudmVsb3ApOiBQcm9taXNlPHN0cmluZz4ge1xuICAgIGNvbnN0IG9wdHMgPSB7IGFkZHJlc3M6IFwiXCIgfTtcbiAgICBpZiAodGhpcy5hY2NvdW50ICYmIHRoaXMuYWNjb3VudC5hZGRyZXNzKSB7XG4gICAgICBvcHRzLmFkZHJlc3MgPSB0aGlzLmFjY291bnQuYWRkcmVzcztcbiAgICB9XG5cbiAgICBpZiAodGhpcy5zaWduZXIgJiYgdGhpcy5zaWduZXIuc2lnbkFuZFNlbmQpIHtcbiAgICAgIHJldHVybiB0aGlzLnNpZ25lci5zaWduQW5kU2VuZChlbnZlbG9wLCBvcHRzKTtcbiAgICB9XG5cbiAgICBsZXQgc2VscDogU2VhbGVkRW52ZWxvcDtcbiAgICBpZiAodGhpcy5zaWduZXIgJiYgdGhpcy5zaWduZXIuc2lnbk9ubHkpIHtcbiAgICAgIHNlbHAgPSBhd2FpdCB0aGlzLnNpZ25lci5zaWduT25seShlbnZlbG9wLCBvcHRzKTtcbiAgICB9IGVsc2Uge1xuICAgICAgc2VscCA9IGF3YWl0IHRoaXMuc2lnbkFjdGlvbihlbnZlbG9wKTtcbiAgICB9XG5cbiAgICB0cnkge1xuICAgICAgYXdhaXQgdGhpcy5jbGllbnQuc2VuZEFjdGlvbih7XG4gICAgICAgIGFjdGlvbjogc2VscC5hY3Rpb24oKVxuICAgICAgfSk7XG4gICAgfSBjYXRjaCAoZSkge1xuICAgICAgbGV0IGNvZGUgPSBBY3Rpb25FcnJvckNvZGUuRXJyVW5rbm93bjtcbiAgICAgIGxldCBtZXNzYWdlID0gYHNlbmQgYWN0aW9uIGVycm9yOiAke0pTT04uc3RyaW5naWZ5KGUpfWA7XG4gICAgICBpZiAoZS5kZXRhaWxzKSB7XG4gICAgICAgIG1lc3NhZ2UgPSBlLmRldGFpbHM7XG4gICAgICAgIGlmIChlLmRldGFpbHMubWF0Y2goL15yZWplY3QgZXhpc3RlZCBhY3Rpb24gLiovKSkge1xuICAgICAgICAgIGNvZGUgPSBBY3Rpb25FcnJvckNvZGUuRXJyRXhpc3RlZEFjdGlvbjtcbiAgICAgICAgfSBlbHNlIGlmIChlLmRldGFpbHMubWF0Y2goL15pbnN1ZmZpY2llbnQgYmFsYW5jZSAuKi8pKSB7XG4gICAgICAgICAgY29kZSA9IEFjdGlvbkVycm9yQ29kZS5FcnJCYWxhbmNlO1xuICAgICAgICB9IGVsc2UgaWYgKFxuICAgICAgICAgIGUuZGV0YWlscy5tYXRjaCgvLiogbG93ZXIgdGhhbiBtaW5pbWFsIGdhcyBwcmljZSB0aHJlc2hvbGQkLylcbiAgICAgICAgKSB7XG4gICAgICAgICAgY29kZSA9IEFjdGlvbkVycm9yQ29kZS5FcnJHYXNQcmljZTtcbiAgICAgICAgfSBlbHNlIGlmIChlLmRldGFpbHMgPT09IFwiYWN0aW9uIHNvdXJjZSBhZGRyZXNzIGlzIGJsYWNrbGlzdGVkXCIpIHtcbiAgICAgICAgICBjb2RlID0gQWN0aW9uRXJyb3JDb2RlLkVyckFkZHJlc3M7XG4gICAgICAgIH0gZWxzZSBpZiAoZS5kZXRhaWxzLmluZGV4T2YoXCJub25jZVwiKSA+PSAwKSB7XG4gICAgICAgICAgY29kZSA9IEFjdGlvbkVycm9yQ29kZS5FcnJOb25jZTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgICAgdGhyb3cgbmV3IEFjdGlvbkVycm9yKGNvZGUsIG1lc3NhZ2UpO1xuICAgIH1cblxuICAgIHJldHVybiBzZWxwLmhhc2goKTtcbiAgfVxufVxuXG5leHBvcnQgY2xhc3MgVHJhbnNmZXJNZXRob2QgZXh0ZW5kcyBBYnN0cmFjdE1ldGhvZCB7XG4gIHB1YmxpYyB0cmFuc2ZlcjogVHJhbnNmZXI7XG5cbiAgY29uc3RydWN0b3IoXG4gICAgY2xpZW50OiBJUnBjTWV0aG9kLFxuICAgIGFjY291bnQ6IEFjY291bnQsXG4gICAgdHJhbnNmZXI6IFRyYW5zZmVyLFxuICAgIG9wdHM/OiBBYnN0cmFjdE1ldGhvZE9wdHNcbiAgKSB7XG4gICAgc3VwZXIoY2xpZW50LCBhY2NvdW50LCBvcHRzKTtcbiAgICB0aGlzLnRyYW5zZmVyID0gdHJhbnNmZXI7XG4gIH1cblxuICBwdWJsaWMgYXN5bmMgZXhlY3V0ZSgpOiBQcm9taXNlPHN0cmluZz4ge1xuICAgIGNvbnN0IGVudmVsb3AgPSBhd2FpdCB0aGlzLmJhc2VFbnZlbG9wKFxuICAgICAgdGhpcy50cmFuc2Zlci5nYXNMaW1pdCxcbiAgICAgIHRoaXMudHJhbnNmZXIuZ2FzUHJpY2VcbiAgICApO1xuICAgIGVudmVsb3AudHJhbnNmZXIgPSB7XG4gICAgICBhbW91bnQ6IHRoaXMudHJhbnNmZXIuYW1vdW50LFxuICAgICAgcmVjaXBpZW50OiB0aGlzLnRyYW5zZmVyLnJlY2lwaWVudCxcbiAgICAgIHBheWxvYWQ6IEJ1ZmZlci5mcm9tKHRoaXMudHJhbnNmZXIucGF5bG9hZCwgXCJoZXhcIilcbiAgICB9O1xuXG4gICAgcmV0dXJuIHRoaXMuc2VuZEFjdGlvbihlbnZlbG9wKTtcbiAgfVxufVxuXG5leHBvcnQgY2xhc3MgRXhlY3V0aW9uTWV0aG9kIGV4dGVuZHMgQWJzdHJhY3RNZXRob2Qge1xuICBwdWJsaWMgZXhlY3V0aW9uOiBFeGVjdXRpb247XG5cbiAgY29uc3RydWN0b3IoXG4gICAgY2xpZW50OiBJUnBjTWV0aG9kLFxuICAgIGFjY291bnQ6IEFjY291bnQsXG4gICAgZXhlY3V0aW9uOiBFeGVjdXRpb24sXG4gICAgb3B0cz86IEFic3RyYWN0TWV0aG9kT3B0c1xuICApIHtcbiAgICBzdXBlcihjbGllbnQsIGFjY291bnQsIG9wdHMpO1xuICAgIHRoaXMuZXhlY3V0aW9uID0gZXhlY3V0aW9uO1xuICB9XG5cbiAgcHVibGljIGFzeW5jIGV4ZWN1dGUoKTogUHJvbWlzZTxzdHJpbmc+IHtcbiAgICBjb25zdCBlbnZlbG9wID0gYXdhaXQgdGhpcy5iYXNlRW52ZWxvcChcbiAgICAgIHRoaXMuZXhlY3V0aW9uLmdhc0xpbWl0LFxuICAgICAgdGhpcy5leGVjdXRpb24uZ2FzUHJpY2VcbiAgICApO1xuICAgIGVudmVsb3AuZXhlY3V0aW9uID0ge1xuICAgICAgYW1vdW50OiB0aGlzLmV4ZWN1dGlvbi5hbW91bnQsXG4gICAgICBjb250cmFjdDogdGhpcy5leGVjdXRpb24uY29udHJhY3QsXG4gICAgICBkYXRhOiB0aGlzLmV4ZWN1dGlvbi5kYXRhXG4gICAgfTtcblxuICAgIHJldHVybiB0aGlzLnNlbmRBY3Rpb24oZW52ZWxvcCk7XG4gIH1cblxuICBwdWJsaWMgYXN5bmMgc2lnbigpOiBQcm9taXNlPElBY3Rpb24+IHtcbiAgICBjb25zdCBlbnZlbG9wID0gYXdhaXQgdGhpcy5iYXNlRW52ZWxvcChcbiAgICAgIHRoaXMuZXhlY3V0aW9uLmdhc0xpbWl0LFxuICAgICAgdGhpcy5leGVjdXRpb24uZ2FzUHJpY2VcbiAgICApO1xuICAgIGVudmVsb3AuZXhlY3V0aW9uID0ge1xuICAgICAgYW1vdW50OiB0aGlzLmV4ZWN1dGlvbi5hbW91bnQsXG4gICAgICBjb250cmFjdDogdGhpcy5leGVjdXRpb24uY29udHJhY3QsXG4gICAgICBkYXRhOiB0aGlzLmV4ZWN1dGlvbi5kYXRhXG4gICAgfTtcblxuICAgIGNvbnN0IHNlbHAgPSBhd2FpdCB0aGlzLnNpZ25BY3Rpb24oZW52ZWxvcCk7XG4gICAgcmV0dXJuIHNlbHAuYWN0aW9uKCk7XG4gIH1cbn1cblxuZXhwb3J0IGNsYXNzIENsYWltRnJvbVJld2FyZGluZ0Z1bmRNZXRob2QgZXh0ZW5kcyBBYnN0cmFjdE1ldGhvZCB7XG4gIHB1YmxpYyBjbGFpbUZyb25SZXdhcmRGdW5kOiBDbGFpbUZyb21SZXdhcmRpbmdGdW5kO1xuXG4gIGNvbnN0cnVjdG9yKFxuICAgIGNsaWVudDogSVJwY01ldGhvZCxcbiAgICBhY2NvdW50OiBBY2NvdW50LFxuICAgIGNsYWltOiBDbGFpbUZyb21SZXdhcmRpbmdGdW5kLFxuICAgIG9wdHM/OiBBYnN0cmFjdE1ldGhvZE9wdHNcbiAgKSB7XG4gICAgc3VwZXIoY2xpZW50LCBhY2NvdW50LCBvcHRzKTtcbiAgICB0aGlzLmNsYWltRnJvblJld2FyZEZ1bmQgPSBjbGFpbTtcbiAgfVxuXG4gIHB1YmxpYyBhc3luYyBleGVjdXRlKCk6IFByb21pc2U8c3RyaW5nPiB7XG4gICAgY29uc3QgZW52ZWxvcCA9IGF3YWl0IHRoaXMuYmFzZUVudmVsb3AoXG4gICAgICB0aGlzLmNsYWltRnJvblJld2FyZEZ1bmQuZ2FzTGltaXQsXG4gICAgICB0aGlzLmNsYWltRnJvblJld2FyZEZ1bmQuZ2FzUHJpY2VcbiAgICApO1xuICAgIGVudmVsb3AuY2xhaW1Gcm9tUmV3YXJkaW5nRnVuZCA9IHtcbiAgICAgIGFtb3VudDogdGhpcy5jbGFpbUZyb25SZXdhcmRGdW5kLmFtb3VudCxcbiAgICAgIGRhdGE6IHRoaXMuY2xhaW1Gcm9uUmV3YXJkRnVuZC5kYXRhXG4gICAgfTtcblxuICAgIHJldHVybiB0aGlzLnNlbmRBY3Rpb24oZW52ZWxvcCk7XG4gIH1cblxuICBwdWJsaWMgYXN5bmMgc2lnbigpOiBQcm9taXNlPElBY3Rpb24+IHtcbiAgICBjb25zdCBlbnZlbG9wID0gYXdhaXQgdGhpcy5iYXNlRW52ZWxvcChcbiAgICAgIHRoaXMuY2xhaW1Gcm9uUmV3YXJkRnVuZC5nYXNMaW1pdCxcbiAgICAgIHRoaXMuY2xhaW1Gcm9uUmV3YXJkRnVuZC5nYXNQcmljZVxuICAgICk7XG4gICAgZW52ZWxvcC5jbGFpbUZyb21SZXdhcmRpbmdGdW5kID0ge1xuICAgICAgYW1vdW50OiB0aGlzLmNsYWltRnJvblJld2FyZEZ1bmQuYW1vdW50LFxuICAgICAgZGF0YTogdGhpcy5jbGFpbUZyb25SZXdhcmRGdW5kLmRhdGFcbiAgICB9O1xuXG4gICAgY29uc3Qgc2VscCA9IGF3YWl0IHRoaXMuc2lnbkFjdGlvbihlbnZlbG9wKTtcbiAgICByZXR1cm4gc2VscC5hY3Rpb24oKTtcbiAgfVxufVxuIl19
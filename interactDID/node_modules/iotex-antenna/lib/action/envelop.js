"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.SealedEnvelop = exports.Envelop = void 0;

var _action_pb = _interopRequireDefault(require("../../protogen/proto/types/action_pb"));

var _crypto = require("../crypto/crypto");

var _hash = require("../crypto/hash");

var _types = require("../rpc-method/types");

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

function _defineProperty(obj, key, value) { if (key in obj) { Object.defineProperty(obj, key, { value: value, enumerable: true, configurable: true, writable: true }); } else { obj[key] = value; } return obj; }

class Envelop {
  // optional fields
  constructor(version, nonce, gasLimit, gasPrice) {
    _defineProperty(this, "version", void 0);

    _defineProperty(this, "nonce", void 0);

    _defineProperty(this, "gasLimit", void 0);

    _defineProperty(this, "gasPrice", void 0);

    _defineProperty(this, "transfer", void 0);

    _defineProperty(this, "execution", void 0);

    _defineProperty(this, "startSubChain", void 0);

    _defineProperty(this, "stopSubChain", void 0);

    _defineProperty(this, "putBlock", void 0);

    _defineProperty(this, "createDeposit", void 0);

    _defineProperty(this, "settleDeposit", void 0);

    _defineProperty(this, "createPlumChain", void 0);

    _defineProperty(this, "terminatePlumChain", void 0);

    _defineProperty(this, "plumPutBlock", void 0);

    _defineProperty(this, "plumCreateDeposit", void 0);

    _defineProperty(this, "plumStartExit", void 0);

    _defineProperty(this, "plumChallengeExit", void 0);

    _defineProperty(this, "plumResponseChallengeExit", void 0);

    _defineProperty(this, "plumFinalizeExit", void 0);

    _defineProperty(this, "plumSettleDeposit", void 0);

    _defineProperty(this, "plumTransfer", void 0);

    _defineProperty(this, "depositToRewardingFund", void 0);

    _defineProperty(this, "claimFromRewardingFund", void 0);

    _defineProperty(this, "grantReward", void 0);

    _defineProperty(this, "putPollResult", void 0);

    this.version = version;
    this.nonce = nonce;
    this.gasLimit = gasLimit;
    this.gasPrice = gasPrice;
  } // tslint:disable-next-line:cyclomatic-complexity


  core() {
    const gasLimit = this.gasLimit || "0";
    const gasPrice = this.gasPrice || "0";
    const pbActionCore = new _action_pb.default.ActionCore();
    pbActionCore.setVersion(this.version);
    pbActionCore.setNonce(Number(this.nonce));
    pbActionCore.setGaslimit(Number(gasLimit));
    pbActionCore.setGasprice(gasPrice); // oneof action

    if (this.transfer) {
      pbActionCore.setTransfer((0, _types.toActionTransfer)(this.transfer));
    } else if (this.execution) {
      pbActionCore.setExecution((0, _types.toActionExecution)(this.execution));
    } else if (this.startSubChain) {
      pbActionCore.setStartsubchain((0, _types.toActionStartSubChain)(this.startSubChain));
    } else if (this.stopSubChain) {
      pbActionCore.setStopsubchain((0, _types.toActionStopSubChain)(this.stopSubChain));
    } else if (this.putBlock) {
      pbActionCore.setPutblock((0, _types.toActionPutBlock)(this.putBlock));
    } else if (this.createDeposit) {
      pbActionCore.setCreatedeposit((0, _types.toActionCreateDeposit)(this.createDeposit));
    } else if (this.settleDeposit) {
      pbActionCore.setSettledeposit((0, _types.toActionSettleDeposit)(this.settleDeposit));
    } else if (this.createPlumChain) {
      pbActionCore.setCreateplumchain((0, _types.toActionCreatePlumChain)(this.createPlumChain));
    } else if (this.terminatePlumChain) {
      pbActionCore.setTerminateplumchain((0, _types.toActionTerminatePlumChain)(this.terminatePlumChain));
    } else if (this.plumPutBlock) {
      pbActionCore.setPlumputblock((0, _types.toActionPlumPutBlock)(this.plumPutBlock));
    } else if (this.plumCreateDeposit) {
      pbActionCore.setPlumcreatedeposit((0, _types.toActionPlumCreateDeposit)(this.plumCreateDeposit));
    } else if (this.plumStartExit) {
      pbActionCore.setPlumstartexit((0, _types.toActionPlumStartExit)(this.plumStartExit));
    } else if (this.plumChallengeExit) {
      pbActionCore.setPlumchallengeexit((0, _types.toActionPlumChallengeExit)(this.plumChallengeExit));
    } else if (this.plumResponseChallengeExit) {
      pbActionCore.setPlumresponsechallengeexit((0, _types.toActionPlumResponseChallengeExit)(this.plumResponseChallengeExit));
    } else if (this.plumFinalizeExit) {
      pbActionCore.setPlumfinalizeexit((0, _types.toActionPlumFinalizeExit)(this.plumFinalizeExit));
    } else if (this.plumSettleDeposit) {
      pbActionCore.setPlumsettledeposit((0, _types.toActionPlumSettleDeposit)(this.plumSettleDeposit));
    } else if (this.plumTransfer) {
      pbActionCore.setPlumtransfer((0, _types.toActionPlumTransfer)(this.plumTransfer));
    } else if (this.depositToRewardingFund) {
      pbActionCore.setDeposittorewardingfund((0, _types.toActionDepositToRewardingFund)(this.depositToRewardingFund));
    } else if (this.claimFromRewardingFund) {
      pbActionCore.setClaimfromrewardingfund((0, _types.toActionClaimFromRewardingFund)(this.claimFromRewardingFund));
    } else if (this.grantReward) {
      pbActionCore.setGrantreward((0, _types.toActionGrantReward)(this.grantReward));
    }

    return pbActionCore;
  }

  bytestream() {
    return this.core().serializeBinary();
  }

  static deserialize(bytes) {
    const pbActionCore = _action_pb.default.ActionCore.deserializeBinary(bytes);

    const envelop = new Envelop(pbActionCore.getVersion(), String(pbActionCore.getNonce()), String(pbActionCore.getGaslimit()), pbActionCore.getGasprice());
    envelop.transfer = _types.GetActionsRequest.fromTransfer(pbActionCore.getTransfer());
    envelop.execution = _types.GetActionsRequest.fromExecution(pbActionCore.getExecution());
    envelop.claimFromRewardingFund = _types.GetActionsRequest.fromClaimFromRewardingFund(pbActionCore.getClaimfromrewardingfund()); // TODO(tian): add more fields

    return envelop;
  }

}

exports.Envelop = Envelop;

class SealedEnvelop {
  constructor(act, senderPubKey, signature) {
    _defineProperty(this, "act", void 0);

    _defineProperty(this, "senderPubKey", void 0);

    _defineProperty(this, "signature", void 0);

    this.act = act;
    this.senderPubKey = senderPubKey;
    this.signature = signature;
  }

  bytestream() {
    const pbActionCore = this.act.core();
    const pbAction = new _action_pb.default.Action();
    pbAction.setCore(pbActionCore);
    pbAction.setSenderpubkey(this.senderPubKey);
    pbAction.setSignature(this.signature);
    return pbAction.serializeBinary();
  }

  hash() {
    return Buffer.from((0, _hash.hash256b)(this.bytestream())).toString("hex");
  }

  action() {
    const gasLimit = this.act.gasLimit || "0";
    const gasPrice = this.act.gasPrice || "0";
    return {
      core: {
        version: this.act.version,
        nonce: this.act.nonce,
        gasLimit: gasLimit,
        gasPrice: gasPrice,
        transfer: this.act.transfer,
        execution: this.act.execution,
        startSubChain: this.act.startSubChain,
        stopSubChain: this.act.stopSubChain,
        putBlock: this.act.putBlock,
        createDeposit: this.act.createDeposit,
        settleDeposit: this.act.settleDeposit,
        createPlumChain: this.act.createPlumChain,
        terminatePlumChain: this.act.terminatePlumChain,
        plumPutBlock: this.act.plumPutBlock,
        plumCreateDeposit: this.act.plumCreateDeposit,
        plumStartExit: this.act.plumStartExit,
        plumChallengeExit: this.act.plumChallengeExit,
        plumResponseChallengeExit: this.act.plumResponseChallengeExit,
        plumFinalizeExit: this.act.plumFinalizeExit,
        plumSettleDeposit: this.act.plumSettleDeposit,
        plumTransfer: this.act.plumTransfer,
        depositToRewardingFund: this.act.depositToRewardingFund,
        claimFromRewardingFund: this.act.claimFromRewardingFund,
        grantReward: this.act.grantReward,
        putPollResult: this.act.putPollResult
      },
      senderPubKey: this.senderPubKey,
      signature: this.signature
    };
  }

  static sign(privateKey, publicKey, act) {
    const h = (0, _hash.hash256b)(act.bytestream());
    const sign = Buffer.from((0, _crypto.makeSigner)(0)(h.toString("hex"), privateKey), "hex");
    return new SealedEnvelop(act, Buffer.from(publicKey, "hex"), sign);
  }

}

exports.SealedEnvelop = SealedEnvelop;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9hY3Rpb24vZW52ZWxvcC50cyJdLCJuYW1lcyI6WyJFbnZlbG9wIiwiY29uc3RydWN0b3IiLCJ2ZXJzaW9uIiwibm9uY2UiLCJnYXNMaW1pdCIsImdhc1ByaWNlIiwiY29yZSIsInBiQWN0aW9uQ29yZSIsImFjdGlvblBiIiwiQWN0aW9uQ29yZSIsInNldFZlcnNpb24iLCJzZXROb25jZSIsIk51bWJlciIsInNldEdhc2xpbWl0Iiwic2V0R2FzcHJpY2UiLCJ0cmFuc2ZlciIsInNldFRyYW5zZmVyIiwiZXhlY3V0aW9uIiwic2V0RXhlY3V0aW9uIiwic3RhcnRTdWJDaGFpbiIsInNldFN0YXJ0c3ViY2hhaW4iLCJzdG9wU3ViQ2hhaW4iLCJzZXRTdG9wc3ViY2hhaW4iLCJwdXRCbG9jayIsInNldFB1dGJsb2NrIiwiY3JlYXRlRGVwb3NpdCIsInNldENyZWF0ZWRlcG9zaXQiLCJzZXR0bGVEZXBvc2l0Iiwic2V0U2V0dGxlZGVwb3NpdCIsImNyZWF0ZVBsdW1DaGFpbiIsInNldENyZWF0ZXBsdW1jaGFpbiIsInRlcm1pbmF0ZVBsdW1DaGFpbiIsInNldFRlcm1pbmF0ZXBsdW1jaGFpbiIsInBsdW1QdXRCbG9jayIsInNldFBsdW1wdXRibG9jayIsInBsdW1DcmVhdGVEZXBvc2l0Iiwic2V0UGx1bWNyZWF0ZWRlcG9zaXQiLCJwbHVtU3RhcnRFeGl0Iiwic2V0UGx1bXN0YXJ0ZXhpdCIsInBsdW1DaGFsbGVuZ2VFeGl0Iiwic2V0UGx1bWNoYWxsZW5nZWV4aXQiLCJwbHVtUmVzcG9uc2VDaGFsbGVuZ2VFeGl0Iiwic2V0UGx1bXJlc3BvbnNlY2hhbGxlbmdlZXhpdCIsInBsdW1GaW5hbGl6ZUV4aXQiLCJzZXRQbHVtZmluYWxpemVleGl0IiwicGx1bVNldHRsZURlcG9zaXQiLCJzZXRQbHVtc2V0dGxlZGVwb3NpdCIsInBsdW1UcmFuc2ZlciIsInNldFBsdW10cmFuc2ZlciIsImRlcG9zaXRUb1Jld2FyZGluZ0Z1bmQiLCJzZXREZXBvc2l0dG9yZXdhcmRpbmdmdW5kIiwiY2xhaW1Gcm9tUmV3YXJkaW5nRnVuZCIsInNldENsYWltZnJvbXJld2FyZGluZ2Z1bmQiLCJncmFudFJld2FyZCIsInNldEdyYW50cmV3YXJkIiwiYnl0ZXN0cmVhbSIsInNlcmlhbGl6ZUJpbmFyeSIsImRlc2VyaWFsaXplIiwiYnl0ZXMiLCJkZXNlcmlhbGl6ZUJpbmFyeSIsImVudmVsb3AiLCJnZXRWZXJzaW9uIiwiU3RyaW5nIiwiZ2V0Tm9uY2UiLCJnZXRHYXNsaW1pdCIsImdldEdhc3ByaWNlIiwiR2V0QWN0aW9uc1JlcXVlc3QiLCJmcm9tVHJhbnNmZXIiLCJnZXRUcmFuc2ZlciIsImZyb21FeGVjdXRpb24iLCJnZXRFeGVjdXRpb24iLCJmcm9tQ2xhaW1Gcm9tUmV3YXJkaW5nRnVuZCIsImdldENsYWltZnJvbXJld2FyZGluZ2Z1bmQiLCJTZWFsZWRFbnZlbG9wIiwiYWN0Iiwic2VuZGVyUHViS2V5Iiwic2lnbmF0dXJlIiwicGJBY3Rpb24iLCJBY3Rpb24iLCJzZXRDb3JlIiwic2V0U2VuZGVycHVia2V5Iiwic2V0U2lnbmF0dXJlIiwiaGFzaCIsIkJ1ZmZlciIsImZyb20iLCJ0b1N0cmluZyIsImFjdGlvbiIsInB1dFBvbGxSZXN1bHQiLCJzaWduIiwicHJpdmF0ZUtleSIsInB1YmxpY0tleSIsImgiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7QUFBQTs7QUFDQTs7QUFDQTs7QUFDQTs7Ozs7O0FBOENPLE1BQU1BLE9BQU4sQ0FBYztBQU1uQjtBQXVCQUMsRUFBQUEsV0FBVyxDQUNUQyxPQURTLEVBRVRDLEtBRlMsRUFHVEMsUUFIUyxFQUlUQyxRQUpTLEVBS1Q7QUFBQTs7QUFBQTs7QUFBQTs7QUFBQTs7QUFBQTs7QUFBQTs7QUFBQTs7QUFBQTs7QUFBQTs7QUFBQTs7QUFBQTs7QUFBQTs7QUFBQTs7QUFBQTs7QUFBQTs7QUFBQTs7QUFBQTs7QUFBQTs7QUFBQTs7QUFBQTs7QUFBQTs7QUFBQTs7QUFBQTs7QUFBQTs7QUFBQTs7QUFDQSxTQUFLSCxPQUFMLEdB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UUFBRixDQUFXLEtBQVgsQ0FBZCxFQUFpQ0ksVUFBakMsQ0FEVyxFQUVYLEtBRlcsQ0FBYjtBQUlBLFdBQU8sSUFBSWhCLGFBQUosQ0FBa0JDLEdBQWxCLEVBQXVCUyxNQUFNLENBQUNDLElBQVAsQ0FBWU0sU0FBWixFQUF1QixLQUF2QixDQUF2QixFQUFzREYsSUFBdEQsQ0FBUDtBQUNEOztBQXhFd0IiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgYWN0aW9uUGIgZnJvbSBcIi4uLy4uL3Byb3RvZ2VuL3Byb3RvL3R5cGVzL2FjdGlvbl9wYlwiO1xuaW1wb3J0IHsgbWFrZVNpZ25lciB9IGZyb20gXCIuLi9jcnlwdG8vY3J5cHRvXCI7XG5pbXBvcnQgeyBoYXNoMjU2YiB9IGZyb20gXCIuLi9jcnlwdG8vaGFzaFwiO1xuaW1wb3J0IHtcbiAgR2V0QWN0aW9uc1JlcXVlc3QsXG4gIElBY3Rpb24sXG4gIElDbGFpbUZyb21SZXdhcmRpbmdGdW5kLFxuICBJQ3JlYXRlRGVwb3NpdCxcbiAgSUNyZWF0ZVBsdW1DaGFpbixcbiAgSURlcG9zaXRUb1Jld2FyZGluZ0Z1bmQsXG4gIElFeGVjdXRpb24sXG4gIElHcmFudFJld2FyZCxcbiAgSVBsdW1DaGFsbGVuZ2VFeGl0LFxuICBJUGx1bUNyZWF0ZURlcG9zaXQsXG4gIElQbHVtRmluYWxpemVFeGl0LFxuICBJUGx1bVB1dEJsb2NrLFxuICBJUGx1bVJlc3BvbnNlQ2hhbGxlbmdlRXhpdCxcbiAgSVBsdW1TZXR0bGVEZXBvc2l0LFxuICBJUGx1bVN0YXJ0RXhpdCxcbiAgSVBsdW1UcmFuc2ZlcixcbiAgSVB1dEJsb2NrLFxuICBJUHV0UG9sbFJlc3VsdCxcbiAgSVNldHRsZURlcG9zaXQsXG4gIElTdGFydFN1YkNoYWluLFxuICBJU3RvcFN1YkNoYWluLFxuICBJVGVybWluYXRlUGx1bUNoYWluLFxuICBJVHJhbnNmZXIsXG4gIHRvQWN0aW9uQ2xhaW1Gcm9tUmV3YXJkaW5nRnVuZCxcbiAgdG9BY3Rpb25DcmVhdGVEZXBvc2l0LFxuICB0b0FjdGlvbkNyZWF0ZVBsdW1DaGFpbixcbiAgdG9BY3Rpb25EZXBvc2l0VG9SZXdhcmRpbmdGdW5kLFxuICB0b0FjdGlvbkV4ZWN1dGlvbixcbiAgdG9BY3Rpb25HcmFudFJld2FyZCxcbiAgdG9BY3Rpb25QbHVtQ2hhbGxlbmdlRXhpdCxcbiAgdG9BY3Rpb25QbHVtQ3JlYXRlRGVwb3NpdCxcbiAgdG9BY3Rpb25QbHVtRmluYWxpemVFeGl0LFxuICB0b0FjdGlvblBsdW1QdXRCbG9jayxcbiAgdG9BY3Rpb25QbHVtUmVzcG9uc2VDaGFsbGVuZ2VFeGl0LFxuICB0b0FjdGlvblBsdW1TZXR0bGVEZXBvc2l0LFxuICB0b0FjdGlvblBsdW1TdGFydEV4aXQsXG4gIHRvQWN0aW9uUGx1bVRyYW5zZmVyLFxuICB0b0FjdGlvblB1dEJsb2NrLFxuICB0b0FjdGlvblNldHRsZURlcG9zaXQsXG4gIHRvQWN0aW9uU3RhcnRTdWJDaGFpbixcbiAgdG9BY3Rpb25TdG9wU3ViQ2hhaW4sXG4gIHRvQWN0aW9uVGVybWluYXRlUGx1bUNoYWluLFxuICB0b0FjdGlvblRyYW5zZmVyXG59IGZyb20gXCIuLi9ycGMtbWV0aG9kL3R5cGVzXCI7XG5cbmV4cG9ydCBjbGFzcyBFbnZlbG9wIHtcbiAgcHVibGljIHZlcnNpb246IG51bWJlcjtcbiAgcHVibGljIG5vbmNlOiBzdHJpbmc7XG4gIHB1YmxpYyBnYXNMaW1pdD86IHN0cmluZyB8IHVuZGVmaW5lZDtcbiAgcHVibGljIGdhc1ByaWNlPzogc3RyaW5nIHwgdW5kZWZpbmVkO1xuXG4gIC8vIG9wdGlvbmFsIGZpZWxkc1xuICBwdWJsaWMgdHJhbnNmZXI/OiBJVHJhbnNmZXIgfCB1bmRlZmluZWQ7XG4gIHB1YmxpYyBleGVjdXRpb24/OiBJRXhlY3V0aW9uIHwgdW5kZWZpbmVkO1xuICBwdWJsaWMgc3RhcnRTdWJDaGFpbj86IElTdGFydFN1YkNoYWluIHwgdW5kZWZpbmVkO1xuICBwdWJsaWMgc3RvcFN1YkNoYWluPzogSVN0b3BTdWJDaGFpbiB8IHVuZGVmaW5lZDtcbiAgcHVibGljIHB1dEJsb2NrPzogSVB1dEJsb2NrIHwgdW5kZWZpbmVkO1xuICBwdWJsaWMgY3JlYXRlRGVwb3NpdD86IElDcmVhdGVEZXBvc2l0IHwgdW5kZWZpbmVkO1xuICBwdWJsaWMgc2V0dGxlRGVwb3NpdD86IElTZXR0bGVEZXBvc2l0IHwgdW5kZWZpbmVkO1xuICBwdWJsaWMgY3JlYXRlUGx1bUNoYWluPzogSUNyZWF0ZVBsdW1DaGFpbiB8IHVuZGVmaW5lZDtcbiAgcHVibGljIHRlcm1pbmF0ZVBsdW1DaGFpbj86IElUZXJtaW5hdGVQbHVtQ2hhaW4gfCB1bmRlZmluZWQ7XG4gIHB1YmxpYyBwbHVtUHV0QmxvY2s/OiBJUGx1bVB1dEJsb2NrIHwgdW5kZWZpbmVkO1xuICBwdWJsaWMgcGx1bUNyZWF0ZURlcG9zaXQ/OiBJUGx1bUNyZWF0ZURlcG9zaXQgfCB1bmRlZmluZWQ7XG4gIHB1YmxpYyBwbHVtU3RhcnRFeGl0PzogSVBsdW1TdGFydEV4aXQgfCB1bmRlZmluZWQ7XG4gIHB1YmxpYyBwbHVtQ2hhbGxlbmdlRXhpdD86IElQbHVtQ2hhbGxlbmdlRXhpdCB8IHVuZGVmaW5lZDtcbiAgcHVibGljIHBsdW1SZXNwb25zZUNoYWxsZW5nZUV4aXQ/OiBJUGx1bVJlc3BvbnNlQ2hhbGxlbmdlRXhpdCB8IHVuZGVmaW5lZDtcbiAgcHVibGljIHBsdW1GaW5hbGl6ZUV4aXQ/OiBJUGx1bUZpbmFsaXplRXhpdCB8IHVuZGVmaW5lZDtcbiAgcHVibGljIHBsdW1TZXR0bGVEZXBvc2l0PzogSVBsdW1TZXR0bGVEZXBvc2l0IHwgdW5kZWZpbmVkO1xuICBwdWJsaWMgcGx1bVRyYW5zZmVyPzogSVBsdW1UcmFuc2ZlciB8IHVuZGVmaW5lZDtcbiAgcHVibGljIGRlcG9zaXRUb1Jld2FyZGluZ0Z1bmQ/OiBJRGVwb3NpdFRvUmV3YXJkaW5nRnVuZCB8IHVuZGVmaW5lZDtcbiAgcHVibGljIGNsYWltRnJvbVJld2FyZGluZ0Z1bmQ/OiBJQ2xhaW1Gcm9tUmV3YXJkaW5nRnVuZCB8IHVuZGVmaW5lZDtcbiAgcHVibGljIGdyYW50UmV3YXJkPzogSUdyYW50UmV3YXJkIHwgdW5kZWZpbmVkO1xuICBwdWJsaWMgcHV0UG9sbFJlc3VsdD86IElQdXRQb2xsUmVzdWx0IHwgdW5kZWZpbmVkO1xuXG4gIGNvbnN0cnVjdG9yKFxuICAgIHZlcnNpb246IG51bWJlcixcbiAgICBub25jZTogc3RyaW5nLFxuICAgIGdhc0xpbWl0Pzogc3RyaW5nLFxuICAgIGdhc1ByaWNlPzogc3RyaW5nXG4gICkge1xuICAgIHRoaXMudmVyc2lvbiA9IHZlcnNpb247XG4gICAgdGhpcy5ub25jZSA9IG5vbmNlO1xuICAgIHRoaXMuZ2FzTGltaXQgPSBnYXNMaW1pdDtcbiAgICB0aGlzLmdhc1ByaWNlID0gZ2FzUHJpY2U7XG4gIH1cblxuICAvLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmU6Y3ljbG9tYXRpYy1jb21wbGV4aXR5XG4gIHB1YmxpYyBjb3JlKCk6IGFjdGlvblBiLkFjdGlvbkNvcmUge1xuICAgIGNvbnN0IGdhc0xpbWl0ID0gdGhpcy5nYXNMaW1pdCB8fCBcIjBcIjtcbiAgICBjb25zdCBnYXNQcmljZSA9IHRoaXMuZ2FzUHJpY2UgfHwgXCIwXCI7XG5cbiAgICBjb25zdCBwYkFjdGlvbkNvcmUgPSBuZXcgYWN0aW9uUGIuQWN0aW9uQ29yZSgpO1xuICAgIHBiQWN0aW9uQ29yZS5zZXRWZXJzaW9uKHRoaXMudmVyc2lvbik7XG4gICAgcGJBY3Rpb25Db3JlLnNldE5vbmNlKE51bWJlcih0aGlzLm5vbmNlKSk7XG4gICAgcGJBY3Rpb25Db3JlLnNldEdhc2xpbWl0KE51bWJlcihnYXNMaW1pdCkpO1xuICAgIHBiQWN0aW9uQ29yZS5zZXRHYXNwcmljZShnYXNQcmljZSk7XG5cbiAgICAvLyBvbmVvZiBhY3Rpb25cbiAgICBpZiAodGhpcy50cmFuc2Zlcikge1xuICAgICAgcGJBY3Rpb25Db3JlLnNldFRyYW5zZmVyKHRvQWN0aW9uVHJhbnNmZXIodGhpcy50cmFuc2ZlcikpO1xuICAgIH0gZWxzZSBpZiAodGhpcy5leGVjdXRpb24pIHtcbiAgICAgIHBiQWN0aW9uQ29yZS5zZXRFeGVjdXRpb24odG9BY3Rpb25FeGVjdXRpb24odGhpcy5leGVjdXRpb24pKTtcbiAgICB9IGVsc2UgaWYgKHRoaXMuc3RhcnRTdWJDaGFpbikge1xuICAgICAgcGJBY3Rpb25Db3JlLnNldFN0YXJ0c3ViY2hhaW4odG9BY3Rpb25TdGFydFN1YkNoYWluKHRoaXMuc3RhcnRTdWJDaGFpbikpO1xuICAgIH0gZWxzZSBpZiAodGhpcy5zdG9wU3ViQ2hhaW4pIHtcbiAgICAgIHBiQWN0aW9uQ29yZS5zZXRTdG9wc3ViY2hhaW4odG9BY3Rpb25TdG9wU3ViQ2hhaW4odGhpcy5zdG9wU3ViQ2hhaW4pKTtcbiAgICB9IGVsc2UgaWYgKHRoaXMucHV0QmxvY2spIHtcbiAgICAgIHBiQWN0aW9uQ29yZS5zZXRQdXRibG9jayh0b0FjdGlvblB1dEJsb2NrKHRoaXMucHV0QmxvY2spKTtcbiAgICB9IGVsc2UgaWYgKHRoaXMuY3JlYXRlRGVwb3NpdCkge1xuICAgICAgcGJBY3Rpb25Db3JlLnNldENyZWF0ZWRlcG9zaXQodG9BY3Rpb25DcmVhdGVEZXBvc2l0KHRoaXMuY3JlYXRlRGVwb3NpdCkpO1xuICAgIH0gZWxzZSBpZiAodGhpcy5zZXR0bGVEZXBvc2l0KSB7XG4gICAgICBwYkFjdGlvbkNvcmUuc2V0U2V0dGxlZGVwb3NpdCh0b0FjdGlvblNldHRsZURlcG9zaXQodGhpcy5zZXR0bGVEZXBvc2l0KSk7XG4gICAgfSBlbHNlIGlmICh0aGlzLmNyZWF0ZVBsdW1DaGFpbikge1xuICAgICAgcGJBY3Rpb25Db3JlLnNldENyZWF0ZXBsdW1jaGFpbihcbiAgICAgICAgdG9BY3Rpb25DcmVhdGVQbHVtQ2hhaW4odGhpcy5jcmVhdGVQbHVtQ2hhaW4pXG4gICAgICApO1xuICAgIH0gZWxzZSBpZiAodGhpcy50ZXJtaW5hdGVQbHVtQ2hhaW4pIHtcbiAgICAgIHBiQWN0aW9uQ29yZS5zZXRUZXJtaW5hdGVwbHVtY2hhaW4oXG4gICAgICAgIHRvQWN0aW9uVGVybWluYXRlUGx1bUNoYWluKHRoaXMudGVybWluYXRlUGx1bUNoYWluKVxuICAgICAgKTtcbiAgICB9IGVsc2UgaWYgKHRoaXMucGx1bVB1dEJsb2NrKSB7XG4gICAgICBwYkFjdGlvbkNvcmUuc2V0UGx1bXB1dGJsb2NrKHRvQWN0aW9uUGx1bVB1dEJsb2NrKHRoaXMucGx1bVB1dEJsb2NrKSk7XG4gICAgfSBlbHNlIGlmICh0aGlzLnBsdW1DcmVhdGVEZXBvc2l0KSB7XG4gICAgICBwYkFjdGlvbkNvcmUuc2V0UGx1bWNyZWF0ZWRlcG9zaXQoXG4gICAgICAgIHRvQWN0aW9uUGx1bUNyZWF0ZURlcG9zaXQodGhpcy5wbHVtQ3JlYXRlRGVwb3NpdClcbiAgICAgICk7XG4gICAgfSBlbHNlIGlmICh0aGlzLnBsdW1TdGFydEV4aXQpIHtcbiAgICAgIHBiQWN0aW9uQ29yZS5zZXRQbHVtc3RhcnRleGl0KHRvQWN0aW9uUGx1bVN0YXJ0RXhpdCh0aGlzLnBsdW1TdGFydEV4aXQpKTtcbiAgICB9IGVsc2UgaWYgKHRoaXMucGx1bUNoYWxsZW5nZUV4aXQpIHtcbiAgICAgIHBiQWN0aW9uQ29yZS5zZXRQbHVtY2hhbGxlbmdlZXhpdChcbiAgICAgICAgdG9BY3Rpb25QbHVtQ2hhbGxlbmdlRXhpdCh0aGlzLnBsdW1DaGFsbGVuZ2VFeGl0KVxuICAgICAgKTtcbiAgICB9IGVsc2UgaWYgKHRoaXMucGx1bVJlc3BvbnNlQ2hhbGxlbmdlRXhpdCkge1xuICAgICAgcGJBY3Rpb25Db3JlLnNldFBsdW1yZXNwb25zZWNoYWxsZW5nZWV4aXQoXG4gICAgICAgIHRvQWN0aW9uUGx1bVJlc3BvbnNlQ2hhbGxlbmdlRXhpdCh0aGlzLnBsdW1SZXNwb25zZUNoYWxsZW5nZUV4aXQpXG4gICAgICApO1xuICAgIH0gZWxzZSBpZiAodGhpcy5wbHVtRmluYWxpemVFeGl0KSB7XG4gICAgICBwYkFjdGlvbkNvcmUuc2V0UGx1bWZpbmFsaXplZXhpdChcbiAgICAgICAgdG9BY3Rpb25QbHVtRmluYWxpemVFeGl0KHRoaXMucGx1bUZpbmFsaXplRXhpdClcbiAgICAgICk7XG4gICAgfSBlbHNlIGlmICh0aGlzLnBsdW1TZXR0bGVEZXBvc2l0KSB7XG4gICAgICBwYkFjdGlvbkNvcmUuc2V0UGx1bXNldHRsZWRlcG9zaXQoXG4gICAgICAgIHRvQWN0aW9uUGx1bVNldHRsZURlcG9zaXQodGhpcy5wbHVtU2V0dGxlRGVwb3NpdClcbiAgICAgICk7XG4gICAgfSBlbHNlIGlmICh0aGlzLnBsdW1UcmFuc2Zlcikge1xuICAgICAgcGJBY3Rpb25Db3JlLnNldFBsdW10cmFuc2Zlcih0b0FjdGlvblBsdW1UcmFuc2Zlcih0aGlzLnBsdW1UcmFuc2ZlcikpO1xuICAgIH0gZWxzZSBpZiAodGhpcy5kZXBvc2l0VG9SZXdhcmRpbmdGdW5kKSB7XG4gICAgICBwYkFjdGlvbkNvcmUuc2V0RGVwb3NpdHRvcmV3YXJkaW5nZnVuZChcbiAgICAgICAgdG9BY3Rpb25EZXBvc2l0VG9SZXdhcmRpbmdGdW5kKHRoaXMuZGVwb3NpdFRvUmV3YXJkaW5nRnVuZClcbiAgICAgICk7XG4gICAgfSBlbHNlIGlmICh0aGlzLmNsYWltRnJvbVJld2FyZGluZ0Z1bmQpIHtcbiAgICAgIHBiQWN0aW9uQ29yZS5zZXRDbGFpbWZyb21yZXdhcmRpbmdmdW5kKFxuICAgICAgICB0b0FjdGlvbkNsYWltRnJvbVJld2FyZGluZ0Z1bmQodGhpcy5jbGFpbUZyb21SZXdhcmRpbmdGdW5kKVxuICAgICAgKTtcbiAgICB9IGVsc2UgaWYgKHRoaXMuZ3JhbnRSZXdhcmQpIHtcbiAgICAgIHBiQWN0aW9uQ29yZS5zZXRHcmFudHJld2FyZCh0b0FjdGlvbkdyYW50UmV3YXJkKHRoaXMuZ3JhbnRSZXdhcmQpKTtcbiAgICB9XG4gICAgcmV0dXJuIHBiQWN0aW9uQ29yZTtcbiAgfVxuXG4gIHB1YmxpYyBieXRlc3RyZWFtKCk6IFVpbnQ4QXJyYXkge1xuICAgIHJldHVybiB0aGlzLmNvcmUoKS5zZXJpYWxpemVCaW5hcnkoKTtcbiAgfVxuXG4gIHB1YmxpYyBzdGF0aWMgZGVzZXJpYWxpemUoYnl0ZXM6IFVpbnQ4QXJyYXkpOiBFbnZlbG9wIHtcbiAgICBjb25zdCBwYkFjdGlvbkNvcmUgPSBhY3Rpb25QYi5BY3Rpb25Db3JlLmRlc2VyaWFsaXplQmluYXJ5KGJ5dGVzKTtcbiAgICBjb25zdCBlbnZlbG9wID0gbmV3IEVudmVsb3AoXG4gICAgICBwYkFjdGlvbkNvcmUuZ2V0VmVyc2lvbigpLFxuICAgICAgU3RyaW5nKHBiQWN0aW9uQ29yZS5nZXROb25jZSgpKSxcbiAgICAgIFN0cmluZyhwYkFjdGlvbkNvcmUuZ2V0R2FzbGltaXQoKSksXG4gICAgICBwYkFjdGlvbkNvcmUuZ2V0R2FzcHJpY2UoKVxuICAgICk7XG4gICAgZW52ZWxvcC50cmFuc2ZlciA9IEdldEFjdGlvbnNSZXF1ZXN0LmZyb21UcmFuc2ZlcihcbiAgICAgIHBiQWN0aW9uQ29yZS5nZXRUcmFuc2ZlcigpXG4gICAgKTtcbiAgICBlbnZlbG9wLmV4ZWN1dGlvbiA9IEdldEFjdGlvbnNSZXF1ZXN0LmZyb21FeGVjdXRpb24oXG4gICAgICBwYkFjdGlvbkNvcmUuZ2V0RXhlY3V0aW9uKClcbiAgICApO1xuICAgIGVudmVsb3AuY2xhaW1Gcm9tUmV3YXJkaW5nRnVuZCA9IEdldEFjdGlvbnNSZXF1ZXN0LmZyb21DbGFpbUZyb21SZXdhcmRpbmdGdW5kKFxuICAgICAgcGJBY3Rpb25Db3JlLmdldENsYWltZnJvbXJld2FyZGluZ2Z1bmQoKVxuICAgICk7XG4gICAgLy8gVE9ETyh0aWFuKTogYWRkIG1vcmUgZmllbGRzXG4gICAgcmV0dXJuIGVudmVsb3A7XG4gIH1cbn1cblxuZXhwb3J0IGNsYXNzIFNlYWxlZEVudmVsb3Age1xuICBwdWJsaWMgYWN0OiBFbnZlbG9wO1xuICBwdWJsaWMgc2VuZGVyUHViS2V5OiBCdWZmZXI7XG4gIHB1YmxpYyBzaWduYXR1cmU6IEJ1ZmZlcjtcblxuICBjb25zdHJ1Y3RvcihhY3Q6IEVudmVsb3AsIHNlbmRlclB1YktleTogQnVmZmVyLCBzaWduYXR1cmU6IEJ1ZmZlcikge1xuICAgIHRoaXMuYWN0ID0gYWN0O1xuICAgIHRoaXMuc2VuZGVyUHViS2V5ID0gc2VuZGVyUHViS2V5O1xuICAgIHRoaXMuc2lnbmF0dXJlID0gc2lnbmF0dXJlO1xuICB9XG5cbiAgcHVibGljIGJ5dGVzdHJlYW0oKTogVWludDhBcnJheSB7XG4gICAgY29uc3QgcGJBY3Rpb25Db3JlID0gdGhpcy5hY3QuY29yZSgpO1xuICAgIGNvbnN0IHBiQWN0aW9uID0gbmV3IGFjdGlvblBiLkFjdGlvbigpO1xuICAgIHBiQWN0aW9uLnNldENvcmUocGJBY3Rpb25Db3JlKTtcbiAgICBwYkFjdGlvbi5zZXRTZW5kZXJwdWJrZXkodGhpcy5zZW5kZXJQdWJLZXkpO1xuICAgIHBiQWN0aW9uLnNldFNpZ25hdHVyZSh0aGlzLnNpZ25hdHVyZSk7XG4gICAgcmV0dXJuIHBiQWN0aW9uLnNlcmlhbGl6ZUJpbmFyeSgpO1xuICB9XG5cbiAgcHVibGljIGhhc2goKTogc3RyaW5nIHtcbiAgICByZXR1cm4gQnVmZmVyLmZyb20oaGFzaDI1NmIodGhpcy5ieXRlc3RyZWFtKCkpKS50b1N0cmluZyhcImhleFwiKTtcbiAgfVxuXG4gIHB1YmxpYyBhY3Rpb24oKTogSUFjdGlvbiB7XG4gICAgY29uc3QgZ2FzTGltaXQgPSB0aGlzLmFjdC5nYXNMaW1pdCB8fCBcIjBcIjtcbiAgICBjb25zdCBnYXNQcmljZSA9IHRoaXMuYWN0Lmdhc1ByaWNlIHx8IFwiMFwiO1xuXG4gICAgcmV0dXJuIHtcbiAgICAgIGNvcmU6IHtcbiAgICAgICAgdmVyc2lvbjogdGhpcy5hY3QudmVyc2lvbixcbiAgICAgICAgbm9uY2U6IHRoaXMuYWN0Lm5vbmNlLFxuICAgICAgICBnYXNMaW1pdDogZ2FzTGltaXQsXG4gICAgICAgIGdhc1ByaWNlOiBnYXNQcmljZSxcbiAgICAgICAgdHJhbnNmZXI6IHRoaXMuYWN0LnRyYW5zZmVyLFxuICAgICAgICBleGVjdXRpb246IHRoaXMuYWN0LmV4ZWN1dGlvbixcbiAgICAgICAgc3RhcnRTdWJDaGFpbjogdGhpcy5hY3Quc3RhcnRTdWJDaGFpbixcbiAgICAgICAgc3RvcFN1YkNoYWluOiB0aGlzLmFjdC5zdG9wU3ViQ2hhaW4sXG4gICAgICAgIHB1dEJsb2NrOiB0aGlzLmFjdC5wdXRCbG9jayxcbiAgICAgICAgY3JlYXRlRGVwb3NpdDogdGhpcy5hY3QuY3JlYXRlRGVwb3NpdCxcbiAgICAgICAgc2V0dGxlRGVwb3NpdDogdGhpcy5hY3Quc2V0dGxlRGVwb3NpdCxcbiAgICAgICAgY3JlYXRlUGx1bUNoYWluOiB0aGlzLmFjdC5jcmVhdGVQbHVtQ2hhaW4sXG4gICAgICAgIHRlcm1pbmF0ZVBsdW1DaGFpbjogdGhpcy5hY3QudGVybWluYXRlUGx1bUNoYWluLFxuICAgICAgICBwbHVtUHV0QmxvY2s6IHRoaXMuYWN0LnBsdW1QdXRCbG9jayxcbiAgICAgICAgcGx1bUNyZWF0ZURlcG9zaXQ6IHRoaXMuYWN0LnBsdW1DcmVhdGVEZXBvc2l0LFxuICAgICAgICBwbHVtU3RhcnRFeGl0OiB0aGlzLmFjdC5wbHVtU3RhcnRFeGl0LFxuICAgICAgICBwbHVtQ2hhbGxlbmdlRXhpdDogdGhpcy5hY3QucGx1bUNoYWxsZW5nZUV4aXQsXG4gICAgICAgIHBsdW1SZXNwb25zZUNoYWxsZW5nZUV4aXQ6IHRoaXMuYWN0LnBsdW1SZXNwb25zZUNoYWxsZW5nZUV4aXQsXG4gICAgICAgIHBsdW1GaW5hbGl6ZUV4aXQ6IHRoaXMuYWN0LnBsdW1GaW5hbGl6ZUV4aXQsXG4gICAgICAgIHBsdW1TZXR0bGVEZXBvc2l0OiB0aGlzLmFjdC5wbHVtU2V0dGxlRGVwb3NpdCxcbiAgICAgICAgcGx1bVRyYW5zZmVyOiB0aGlzLmFjdC5wbHVtVHJhbnNmZXIsXG4gICAgICAgIGRlcG9zaXRUb1Jld2FyZGluZ0Z1bmQ6IHRoaXMuYWN0LmRlcG9zaXRUb1Jld2FyZGluZ0Z1bmQsXG4gICAgICAgIGNsYWltRnJvbVJld2FyZGluZ0Z1bmQ6IHRoaXMuYWN0LmNsYWltRnJvbVJld2FyZGluZ0Z1bmQsXG4gICAgICAgIGdyYW50UmV3YXJkOiB0aGlzLmFjdC5ncmFudFJld2FyZCxcbiAgICAgICAgcHV0UG9sbFJlc3VsdDogdGhpcy5hY3QucHV0UG9sbFJlc3VsdFxuICAgICAgfSxcbiAgICAgIHNlbmRlclB1YktleTogdGhpcy5zZW5kZXJQdWJLZXksXG4gICAgICBzaWduYXR1cmU6IHRoaXMuc2lnbmF0dXJlXG4gICAgfTtcbiAgfVxuXG4gIHB1YmxpYyBzdGF0aWMgc2lnbihcbiAgICBwcml2YXRlS2V5OiBzdHJpbmcsXG4gICAgcHVibGljS2V5OiBzdHJpbmcsXG4gICAgYWN0OiBFbnZlbG9wXG4gICk6IFNlYWxlZEVudmVsb3Age1xuICAgIGNvbnN0IGggPSBoYXNoMjU2YihhY3QuYnl0ZXN0cmVhbSgpKTtcbiAgICBjb25zdCBzaWduID0gQnVmZmVyLmZyb20oXG4gICAgICBtYWtlU2lnbmVyKDApKGgudG9TdHJpbmcoXCJoZXhcIiksIHByaXZhdGVLZXkpLFxuICAgICAgXCJoZXhcIlxuICAgICk7XG4gICAgcmV0dXJuIG5ldyBTZWFsZWRFbnZlbG9wKGFjdCwgQnVmZmVyLmZyb20ocHVibGljS2V5LCBcImhleFwiKSwgc2lnbik7XG4gIH1cbn1cbiJdfQ==
"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.Iotx = void 0;

var _accounts = require("./account/accounts");

var _method = require("./action/method");

var _contract = require("./contract/contract");

var _rpcMethod = _interopRequireDefault(require("./rpc-method"));

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

function _defineProperty(obj, key, value) { if (key in obj) { Object.defineProperty(obj, key, { value: value, enumerable: true, configurable: true, writable: true }); } else { obj[key] = value; } return obj; }

class Iotx extends _rpcMethod.default {
  constructor(hostname, opts) {
    super(hostname);

    _defineProperty(this, "accounts", void 0);

    _defineProperty(this, "signer", void 0);

    this.accounts = new _accounts.Accounts();
    this.signer = opts && opts.signer;
    setTimeout(() => {
      if (this.signer && this.signer.getAccounts) {
        this.signer.getAccounts().then(accounts => {
          accounts.forEach(account => {
            this.accounts.addAccount(account);
          });
        }).catch(err => {
          throw new Error(`fetch remote accounts address error: ${err}`);
        });
      }
    }, 2000);
  }

  async tryGetAccount(address) {
    const sender = this.signer && this.signer.getAccount ? await this.signer.getAccount(address) : this.accounts.getAccount(address);

    if (!sender) {
      throw new Error(`cannot find account: ${address}`);
    }

    return sender;
  }

  currentProvider() {
    return this.client;
  }

  async sendTransfer(req) {
    const sender = await this.tryGetAccount(req.from);
    const payload = req.payload || "";
    return new _method.TransferMethod(this, sender, {
      gasLimit: req.gasLimit,
      gasPrice: req.gasPrice,
      amount: req.value,
      recipient: req.to,
      payload: payload
    }, {
      signer: this.signer
    }).execute();
  } // return action hash


  async deployContract(req, ...args) {
    if (typeof req.abi === "string") {
      try {
        req.abi = JSON.parse(req.abi);
      } catch (e) {
        throw new Error("parse abi to ABIDefinition error");
      }
    }

    const sender = await this.tryGetAccount(req.from); // @ts-ignore

    return new _contract.Contract(req.abi, undefined, {
      data: req.data,
      provider: this,
      signer: this.signer
    }).deploy(sender, args, req.amount, req.gasLimit, req.gasPrice);
  } // return action hash


  async executeContract(req, ...args) {
    if (typeof req.abi === "string") {
      try {
        req.abi = JSON.parse(req.abi);
      } catch (e) {
        throw new Error("parse abi to ABIDefinition error");
      }
    }

    const sender = await this.tryGetAccount(req.from); // @ts-ignore

    const contract = new _contract.Contract(req.abi, req.contractAddress, {
      provider: this,
      signer: this.signer
    });
    return contract.methods[req.method](...args, {
      account: sender,
      amount: req.amount,
      gasLimit: req.gasLimit,
      gasPrice: req.gasPrice
    });
  }

  async readContractByMethod(req, ...args) {
    if (typeof req.abi === "string") {
      try {
        req.abi = JSON.parse(req.abi);
      } catch (e) {
        throw new Error("parse abi to ABIDefinition error");
      }
    } // @ts-ignore


    const contract = new _contract.Contract(req.abi, req.contractAddress, {
      provider: this,
      signer: this.signer
    });
    const result = await this.readContract({
      execution: contract.pureEncodeMethod("0", req.method, ...args),
      callerAddress: req.from
    });
    return contract.decodeMethodResult(req.method, result.data);
  }

  async claimFromRewardingFund(req) {
    const sender = await this.tryGetAccount(req.from);
    return new _method.ClaimFromRewardingFundMethod(this, sender, {
      gasLimit: req.gasLimit,
      gasPrice: req.gasPrice,
      amount: req.amount,
      data: req.data
    }, {
      signer: this.signer
    }).execute();
  }

}

exports.Iotx = Iotx;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9pb3R4LnRzIl0sIm5hbWVzIjpbIklvdHgiLCJScGNNZXRob2QiLCJjb25zdHJ1Y3RvciIsImhvc3RuYW1lIiwib3B0cyIsImFjY291bnRzIiwiQWNjb3VudHMiLCJzaWduZXIiLCJzZXRUaW1lb3V0IiwiZ2V0QWNjb3VudHMiLCJ0aGVuIiwiZm9yRWFjaCIsImFjY291bnQiLCJhZGRBY2NvdW50IiwiY2F0Y2giLCJlcnIiLCJFcnJvciIsInRyeUdldEFjY291bnQiLCJhZGRyZXNzIiwic2VuZGVyIiwiZ2V0QWNjb3VudCIsImN1cnJlbnRQcm92aWRlciIsImNsaWVudCIsInNlbmRUcmFuc2ZlciIsInJlcSIsImZyb20iLCJwYXlsb2FkIiwiVHJhbnNmZXJNZXRob2QiLCJnYXNMaW1pdCIsImdhc1ByaWNlIiwiYW1vdW50IiwidmFsdWUiLCJyZWNpcGllbnQiLCJ0byIsImV4ZWN1dGUiLCJkZXBsb3lDb250cmFjdCIsImFyZ3MiLCJhYmkiLCJKU09OIiwicGFyc2UiLCJlIiwiQ29udHJhY3QiLCJ1bmRlZmluZWQiLCJkYXRhIiwicHJvdmlkZXIiLCJkZXBsb3kiLCJleGVjdXRlQ29udHJhY3QiLCJjb250cmFjdCIsImNvbnRyYWN0QWRkcmVzcyIsIm1ldGhvZHMiLCJtZXRob2QiLCJyZWFkQ29udHJhY3RCeU1ldGhvZCIsInJlc3VsdCIsInJlYWRDb250cmFjdCIsImV4ZWN1dGlvbiIsInB1cmVFbmNvZGVNZXRob2QiLCJjYWxsZXJBZGRyZXNzIiwiZGVjb2RlTWV0aG9kUmVzdWx0IiwiY2xhaW1Gcm9tUmV3YXJkaW5nRnVuZCIsIkNsYWltRnJvbVJld2FyZGluZ0Z1bmRNZXRob2QiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7QUFFQTs7QUFDQTs7QUFLQTs7QUFDQTs7Ozs7O0FBV08sTUFBTUEsSUFBTixTQUFtQkMsa0JBQW5CLENBQTZCO0FBSWxDQyxFQUFBQSxXQUFXLENBQUNDLFFBQUQsRUFBbUJDLElBQW5CLEVBQW9DO0FBQzdDLFVBQU1ELFFB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REssRUFFTHhDLE1BRkssRUFHTDtBQUNFUyxNQUFBQSxRQUFRLEVBQUVKLEdBQUcsQ0FBQ0ksUUFEaEI7QUFFRUMsTUFBQUEsUUFBUSxFQUFFTCxHQUFHLENBQUNLLFFBRmhCO0FBR0VDLE1BQUFBLE1BQU0sRUFBRU4sR0FBRyxDQUFDTSxNQUhkO0FBSUVhLE1BQUFBLElBQUksRUFBRW5CLEdBQUcsQ0FBQ21CO0FBSlosS0FISyxFQVNMO0FBQUVwQyxNQUFBQSxNQUFNLEVBQUUsS0FBS0E7QUFBZixLQVRLLEVBVUwyQixPQVZLLEVBQVA7QUFXRDs7QUFySmlDIiwic291cmNlc0NvbnRlbnQiOlsiLyogdHNsaW50OmRpc2FibGU6bm8tYW55ICovXG5pbXBvcnQgeyBBY2NvdW50IH0gZnJvbSBcIi4vYWNjb3VudC9hY2NvdW50XCI7XG5pbXBvcnQgeyBBY2NvdW50cyB9IGZyb20gXCIuL2FjY291bnQvYWNjb3VudHNcIjtcbmltcG9ydCB7XG4gIENsYWltRnJvbVJld2FyZGluZ0Z1bmRNZXRob2QsXG4gIFNpZ25lclBsdWdpbixcbiAgVHJhbnNmZXJNZXRob2Rcbn0gZnJvbSBcIi4vYWN0aW9uL21ldGhvZFwiO1xuaW1wb3J0IHsgQ29udHJhY3QgfSBmcm9tIFwiLi9jb250cmFjdC9jb250cmFjdFwiO1xuaW1wb3J0IFJwY01ldGhvZCBmcm9tIFwiLi9ycGMtbWV0aG9kXCI7XG5pbXBvcnQgeyBJUnBjTWV0aG9kIH0gZnJvbSBcIi4vcnBjLW1ldGhvZC90eXBlc1wiO1xuaW1wb3J0IHtcbiAgQ2xhaW1Gcm9tUmV3YXJkaW5nRnVuZFJlcXVzZXQsXG4gIENvbnRyYWN0UmVxdWVzdCxcbiAgRXhlY3V0ZUNvbnRyYWN0UmVxdWVzdCxcbiAgVHJhbnNmZXJSZXF1ZXN0XG59IGZyb20gXCIuL3R5cGVzXCI7XG5cbnR5cGUgSW90eE9wdHMgPSB7IHNpZ25lcj86IFNpZ25lclBsdWdpbiB9O1xuXG5leHBvcnQgY2xhc3MgSW90eCBleHRlbmRzIFJwY01ldGhvZCB7XG4gIHB1YmxpYyBhY2NvdW50czogQWNjb3VudHM7XG4gIHB1YmxpYyBzaWduZXI/OiBTaWduZXJQbHVnaW47XG5cbiAgY29uc3RydWN0b3IoaG9zdG5hbWU6IHN0cmluZywgb3B0cz86IElvdHhPcHRzKSB7XG4gICAgc3VwZXIoaG9zdG5hbWUpO1xuICAgIHRoaXMuYWNjb3VudHMgPSBuZXcgQWNjb3VudHMoKTtcbiAgICB0aGlzLnNpZ25lciA9IG9wdHMgJiYgb3B0cy5zaWduZXI7XG4gICAgc2V0VGltZW91dCgoKSA9PiB7XG4gICAgICBpZiAodGhpcy5zaWduZXIgJiYgdGhpcy5zaWduZXIuZ2V0QWNjb3VudHMpIHtcbiAgICAgICAgdGhpcy5zaWduZXJcbiAgICAgICAgICAuZ2V0QWNjb3VudHMoKVxuICAgICAgICAgIC50aGVuKGFjY291bnRzID0+IHtcbiAgICAgICAgICAgIGFjY291bnRzLmZvckVhY2goYWNjb3VudCA9PiB7XG4gICAgICAgICAgICAgIHRoaXMuYWNjb3VudHMuYWRkQWNjb3VudChhY2NvdW50KTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICAgIH0pXG4gICAgICAgICAgLmNhdGNoKGVyciA9PiB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYGZldGNoIHJlbW90ZSBhY2NvdW50cyBhZGRyZXNzIGVycm9yOiAke2Vycn1gKTtcbiAgICAgICAgICB9KTtcbiAgICAgIH1cbiAgICB9LCAyMDAwKTtcbiAgfVxuXG4gIHB1YmxpYyBhc3luYyB0cnlHZXRBY2NvdW50KGFkZHJlc3M6IHN0cmluZyk6IFByb21pc2U8QWNjb3VudD4ge1xuICAgIGNvbnN0IHNlbmRlciA9XG4gICAgICB0aGlzLnNpZ25lciAmJiB0aGlzLnNpZ25lci5nZXRBY2NvdW50XG4gICAgICAgID8gYXdhaXQgdGhpcy5zaWduZXIuZ2V0QWNjb3VudChhZGRyZXNzKVxuICAgICAgICA6IHRoaXMuYWNjb3VudHMuZ2V0QWNjb3VudChhZGRyZXNzKTtcbiAgICBpZiAoIXNlbmRlcikge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGBjYW5ub3QgZmluZCBhY2NvdW50OiAke2FkZHJlc3N9YCk7XG4gICAgfVxuICAgIHJldHVybiBzZW5kZXI7XG4gIH1cblxuICBwdWJsaWMgY3VycmVudFByb3ZpZGVyKCk6IElScGNNZXRob2Qge1xuICAgIHJldHVybiB0aGlzLmNsaWVudDtcbiAgfVxuXG4gIHB1YmxpYyBhc3luYyBzZW5kVHJhbnNmZXIocmVxOiBUcmFuc2ZlclJlcXVlc3QpOiBQcm9taXNlPHN0cmluZz4ge1xuICAgIGNvbnN0IHNlbmRlciA9IGF3YWl0IHRoaXMudHJ5R2V0QWNjb3VudChyZXEuZnJvbSk7XG4gICAgY29uc3QgcGF5bG9hZCA9IHJlcS5wYXlsb2FkIHx8IFwiXCI7XG4gICAgcmV0dXJuIG5ldyBUcmFuc2Zlck1ldGhvZChcbiAgICAgIHRoaXMsXG4gICAgICBzZW5kZXIsXG4gICAgICB7XG4gICAgICAgIGdhc0xpbWl0OiByZXEuZ2FzTGltaXQsXG4gICAgICAgIGdhc1ByaWNlOiByZXEuZ2FzUHJpY2UsXG4gICAgICAgIGFtb3VudDogcmVxLnZhbHVlLFxuICAgICAgICByZWNpcGllbnQ6IHJlcS50byxcbiAgICAgICAgcGF5bG9hZDogcGF5bG9hZFxuICAgICAgfSxcbiAgICAgIHsgc2lnbmVyOiB0aGlzLnNpZ25lciB9XG4gICAgKS5leGVjdXRlKCk7XG4gIH1cblxuICAvLyByZXR1cm4gYWN0aW9uIGhhc2hcbiAgcHVibGljIGFzeW5jIGRlcGxveUNvbnRyYWN0KFxuICAgIHJlcTogQ29udHJhY3RSZXF1ZXN0LFxuICAgIC4uLmFyZ3M6IEFycmF5PGFueT5cbiAgKTogUHJvbWlzZTxzdHJpbmc+IHtcbiAgICBpZiAodHlwZW9mIHJlcS5hYmkgPT09IFwic3RyaW5nXCIpIHtcbiAgICAgIHRyeSB7XG4gICAgICAgIHJlcS5hYmkgPSBKU09OLnBhcnNlKHJlcS5hYmkpO1xuICAgICAgfSBjYXRjaCAoZSkge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXCJwYXJzZSBhYmkgdG8gQUJJRGVmaW5pdGlvbiBlcnJvclwiKTtcbiAgICAgIH1cbiAgICB9XG5cbiAgICBjb25zdCBzZW5kZXIgPSBhd2FpdCB0aGlzLnRyeUdldEFjY291bnQocmVxLmZyb20pO1xuXG4gICAgLy8gQHRzLWlnbm9yZVxuICAgIHJldHVybiBuZXcgQ29udHJhY3QocmVxLmFiaSwgdW5kZWZpbmVkLCB7XG4gICAgICBkYXRhOiByZXEuZGF0YSxcbiAgICAgIHByb3ZpZGVyOiB0aGlzLFxuICAgICAgc2lnbmVyOiB0aGlzLnNpZ25lclxuICAgIH0pLmRlcGxveShzZW5kZXIsIGFyZ3MsIHJlcS5hbW91bnQsIHJlcS5nYXNMaW1pdCwgcmVxLmdhc1ByaWNlKTtcbiAgfVxuXG4gIC8vIHJldHVybiBhY3Rpb24gaGFzaFxuICBwdWJsaWMgYXN5bmMgZXhlY3V0ZUNvbnRyYWN0KFxuICAgIHJlcTogRXhlY3V0ZUNvbnRyYWN0UmVxdWVzdCxcbiAgICAuLi5hcmdzOiBBcnJheTxhbnk+XG4gICk6IFByb21pc2U8c3RyaW5nPiB7XG4gICAgaWYgKHR5cGVvZiByZXEuYWJpID09PSBcInN0cmluZ1wiKSB7XG4gICAgICB0cnkge1xuICAgICAgICByZXEuYWJpID0gSlNPTi5wYXJzZShyZXEuYWJpKTtcbiAgICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKFwicGFyc2UgYWJpIHRvIEFCSURlZmluaXRpb24gZXJyb3JcIik7XG4gICAgICB9XG4gICAgfVxuXG4gICAgY29uc3Qgc2VuZGVyID0gYXdhaXQgdGhpcy50cnlHZXRBY2NvdW50KHJlcS5mcm9tKTtcblxuICAgIC8vIEB0cy1pZ25vcmVcbiAgICBjb25zdCBjb250cmFjdCA9IG5ldyBDb250cmFjdChyZXEuYWJpLCByZXEuY29udHJhY3RBZGRyZXNzLCB7XG4gICAgICBwcm92aWRlcjogdGhpcyxcbiAgICAgIHNpZ25lcjogdGhpcy5zaWduZXJcbiAgICB9KTtcbiAgICByZXR1cm4gY29udHJhY3QubWV0aG9kc1tyZXEubWV0aG9kXSguLi5hcmdzLCB7XG4gICAgICBhY2NvdW50OiBzZW5kZXIsXG4gICAgICBhbW91bnQ6IHJlcS5hbW91bnQsXG4gICAgICBnYXNMaW1pdDogcmVxLmdhc0xpbWl0LFxuICAgICAgZ2FzUHJpY2U6IHJlcS5nYXNQcmljZVxuICAgIH0pO1xuICB9XG5cbiAgcHVibGljIGFzeW5jIHJlYWRDb250cmFjdEJ5TWV0aG9kKFxuICAgIHJlcTogRXhlY3V0ZUNvbnRyYWN0UmVxdWVzdCxcbiAgICAuLi5hcmdzOiBBcnJheTxhbnk+XG4gICk6IFByb21pc2U8YW55IHwgQXJyYXk8YW55Pj4ge1xuICAgIGlmICh0eXBlb2YgcmVxLmFiaSA9PT0gXCJzdHJpbmdcIikge1xuICAgICAgdHJ5IHtcbiAgICAgICAgcmVxLmFiaSA9IEpTT04ucGFyc2UocmVxLmFiaSk7XG4gICAgICB9IGNhdGNoIChlKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcihcInBhcnNlIGFiaSB0byBBQklEZWZpbml0aW9uIGVycm9yXCIpO1xuICAgICAgfVxuICAgIH1cblxuICAgIC8vIEB0cy1pZ25vcmVcbiAgICBjb25zdCBjb250cmFjdCA9IG5ldyBDb250cmFjdChyZXEuYWJpLCByZXEuY29udHJhY3RBZGRyZXNzLCB7XG4gICAgICBwcm92aWRlcjogdGhpcyxcbiAgICAgIHNpZ25lcjogdGhpcy5zaWduZXJcbiAgICB9KTtcblxuICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IHRoaXMucmVhZENvbnRyYWN0KHtcbiAgICAgIGV4ZWN1dGlvbjogY29udHJhY3QucHVyZUVuY29kZU1ldGhvZChcIjBcIiwgcmVxLm1ldGhvZCwgLi4uYXJncyksXG4gICAgICBjYWxsZXJBZGRyZXNzOiByZXEuZnJvbVxuICAgIH0pO1xuXG4gICAgcmV0dXJuIGNvbnRyYWN0LmRlY29kZU1ldGhvZFJlc3VsdChyZXEubWV0aG9kLCByZXN1bHQuZGF0YSk7XG4gIH1cblxuICBwdWJsaWMgYXN5bmMgY2xhaW1Gcm9tUmV3YXJkaW5nRnVuZChcbiAgICByZXE6IENsYWltRnJvbVJld2FyZGluZ0Z1bmRSZXF1c2V0XG4gICk6IFByb21pc2U8c3RyaW5nPiB7XG4gICAgY29uc3Qgc2VuZGVyID0gYXdhaXQgdGhpcy50cnlHZXRBY2NvdW50KHJlcS5mcm9tKTtcblxuICAgIHJldHVybiBuZXcgQ2xhaW1Gcm9tUmV3YXJkaW5nRnVuZE1ldGhvZChcbiAgICAgIHRoaXMsXG4gICAgICBzZW5kZXIsXG4gICAgICB7XG4gICAgICAgIGdhc0xpbWl0OiByZXEuZ2FzTGltaXQsXG4gICAgICAgIGdhc1ByaWNlOiByZXEuZ2FzUHJpY2UsXG4gICAgICAgIGFtb3VudDogcmVxLmFtb3VudCxcbiAgICAgICAgZGF0YTogcmVxLmRhdGFcbiAgICAgIH0sXG4gICAgICB7IHNpZ25lcjogdGhpcy5zaWduZXIgfVxuICAgICkuZXhlY3V0ZSgpO1xuICB9XG59XG4iXX0=